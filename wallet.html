<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>monday Wallet — Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
<style>
/* ===== RESET & BASE ===== */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  /* monday.com palette */
  --bg:#F6F7FB;--surface:#FFFFFF;--border:#D0D4E4;--border-light:#E6E9EF;
  --text:#323338;--text-secondary:#676879;--text-muted:#C5C7D0;
  --primary:#0073EA;--primary-hover:#0060C2;--primary-light:#CCE5FF;--primary-bg:rgba(0,115,234,.07);
  --success:#00CA72;--success-bg:rgba(0,202,114,.12);
  --warning:#FDAB3D;--warning-bg:rgba(253,171,61,.14);
  --danger:#E2445C;--danger-bg:rgba(226,68,92,.1);
  --info:#579BFC;--info-bg:rgba(87,155,252,.1);
  --purple:#A25DDC;--purple-bg:rgba(162,93,220,.1);
  --credits:#A25DDC;--credits-bg:rgba(162,93,220,.1);
  --seats:#579BFC;--seats-bg:rgba(87,155,252,.1);
  --vibe:#E8618C;--vibe-bg:rgba(232,97,140,.1);
  --radius:8px;--radius-lg:12px;--radius-sm:4px;
  --shadow:0 1px 4px rgba(0,0,0,.04);
  --shadow-md:0 4px 12px rgba(0,0,0,.06);
  --shadow-lg:0 8px 24px rgba(0,0,0,.1);
  --font:'Poppins',sans-serif;
  --transition:all .18s ease;
}
/* ===== DARK THEME — aligned with landing page palette ===== */
html.dark{
  --bg:#0B0D14;--surface:#131620;--border:rgba(255,255,255,.08);--border-light:rgba(255,255,255,.05);
  --text:#FFFFFF;--text-secondary:#9BA0B4;--text-muted:#4E5368;
  --primary:#FFD93D;--primary-hover:#FFE873;--primary-light:rgba(255,217,61,.12);--primary-bg:rgba(255,217,61,.08);
  --success:#00CA72;--success-bg:rgba(0,202,114,.1);
  --warning:#FDAB3D;--warning-bg:rgba(253,171,61,.1);
  --danger:#FF6B6B;--danger-bg:rgba(255,107,107,.08);
  --info:#579BFC;--info-bg:rgba(87,155,252,.08);
  --purple:#A29BFE;--purple-bg:rgba(162,155,254,.08);
  --credits:#A29BFE;--credits-bg:rgba(162,155,254,.1);
  --seats:#579BFC;--seats-bg:rgba(87,155,252,.1);
  --vibe:#FD79A8;--vibe-bg:rgba(253,121,168,.1);
  --shadow:0 2px 12px rgba(0,0,0,.4);
  --shadow-md:0 4px 20px rgba(0,0,0,.5);
  --shadow-lg:0 8px 40px rgba(0,0,0,.6);
}
html.dark ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1)}
html.dark ::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.18)}
html.dark .header{background:#0E1018;border-bottom:1px solid rgba(255,255,255,.06)}
html.dark .header-icon{box-shadow:0 2px 12px rgba(255,217,61,.25)}
html.dark .card{background:#131620;border-color:rgba(255,255,255,.06);box-shadow:0 2px 16px rgba(0,0,0,.3)}
html.dark th{background:#0E1018}
html.dark tr.data-row:hover td{background:rgba(255,217,61,.03)}
html.dark .details-drawer td{background:#0E1018!important}
html.dark .footer{background:#0E1018;border-top:1px solid rgba(255,255,255,.06)}
html.dark .alloc-row:hover{background:rgba(255,217,61,.03)}
html.dark .pill-healthy{background:var(--success);color:#fff}
html.dark .pill-near{background:var(--warning);color:#1A1D2B}
html.dark .pill-locked{background:var(--text-muted);color:#fff}
html.dark .toast{background:#1A1E2C;color:var(--text);border:1px solid rgba(255,255,255,.08)}
html.dark .toast-success{background:var(--success);border:none}
html.dark .toast-error{background:var(--danger);border:none}
html.dark .toast-info{background:#2A2D3E;border:1px solid rgba(255,217,61,.2);color:var(--primary)}
html.dark .modal-overlay{background:rgba(0,0,0,.7)}
html.dark .input-money,html.dark .input-cap,html.dark .detail-group input,html.dark .detail-group select{
  background:var(--bg);color:var(--text);border-color:var(--border);
}
html.dark select.type-select,html.dark select.dept-select{
  background:var(--bg);color:var(--text);border-color:var(--border);
}
html.dark .modal{background:var(--surface);border:1px solid var(--border)}
html.dark .modal input{background:var(--bg);color:var(--text);border-color:var(--border)}
html.dark .sandbox-badge{background:rgba(255,217,61,.08);color:#FFD93D}
html.dark .plan-tag{background:rgba(255,217,61,.1);color:#FFD93D;border-color:rgba(255,217,61,.3)}

/* Details drawer dark */
html.dark .details-drawer{background:#0E1018;border-bottom-color:rgba(255,255,255,.04)}
html.dark .details-inner{color:var(--text)}
html.dark .detail-group label{color:var(--text-muted)}
html.dark .detail-group input,html.dark .detail-group select{
  background:var(--bg);color:var(--text);border-color:var(--border);
}
html.dark .detail-group input:focus,html.dark .detail-group select:focus{
  border-color:var(--primary);box-shadow:0 0 0 2px var(--primary-bg);
}
html.dark .team-pill{
  background:var(--bg);color:var(--text-secondary);border-color:var(--border);
}
html.dark .team-pill.selected{background:var(--primary);color:#fff;border-color:var(--primary)}
html.dark .team-pill:hover:not(.selected){background:rgba(255,217,61,.06);border-color:rgba(255,217,61,.25)}
html.dark .dept-pill{
  background:var(--bg);color:var(--text-secondary);border-color:var(--border);
}
html.dark .dept-pill.selected{background:var(--info);color:#fff;border-color:var(--info)}
html.dark .dept-pill:hover:not(.selected){background:rgba(116,185,255,.08);border-color:rgba(116,185,255,.3)}
html.dark .toggle{background:var(--border)}
html.dark .toggle.active{background:var(--success)}
html.dark .toggle::after{background:#E8E9ED;box-shadow:0 1px 4px rgba(0,0,0,.3)}
html.dark .btn-details{color:var(--primary)}
html.dark .btn-details:hover{background:var(--primary-bg)}
html.dark .btn-secondary{background:var(--surface);color:var(--text);border-color:var(--border)}
html.dark .btn-secondary:hover{background:var(--bg);border-color:var(--text-muted)}
html.dark .btn-ghost{color:var(--text-secondary)}
html.dark .btn-ghost:hover{background:rgba(255,255,255,.05)}
html.dark .billing-chip{background:var(--bg);border-color:var(--border);color:var(--text-secondary)}
html.dark .billing-chip svg{color:var(--text-muted)}
html.dark .converts-to{color:var(--primary)}
html.dark .offering-sub{color:var(--text-muted)}
html.dark .pool-badge-credits{background:var(--credits-bg);color:var(--credits)}
html.dark .pool-badge-seats{background:var(--seats-bg);color:var(--seats)}
html.dark .pool-badge-vibe{background:var(--vibe-bg);color:var(--vibe)}

/* Dark mode toggle */
.theme-toggle{
  width:36px;height:36px;border-radius:50%;
  background:var(--bg);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all .25s ease;color:var(--text-secondary);
  flex-shrink:0;
}
.theme-toggle:hover{background:var(--primary-bg);border-color:var(--primary);color:var(--primary)}
.theme-toggle svg{width:18px;height:18px;transition:transform .3s ease}
.theme-toggle:hover svg{transform:rotate(30deg)}
.theme-toggle .icon-sun,.theme-toggle .icon-moon{display:none}
html:not(.dark) .theme-toggle .icon-moon{display:block}
html.dark .theme-toggle .icon-sun{display:block}

html,body{height:100%;font-family:var(--font);background:var(--bg);color:var(--text);font-size:13px;line-height:1.5;transition:background .3s ease,color .3s ease}
@media(min-width:901px){html,body{overflow:hidden}}
button{font-family:inherit;cursor:pointer;border:none;outline:none;font-size:inherit}
input,select{font-family:inherit;font-size:inherit;outline:none}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:5px}
::-webkit-scrollbar-thumb:hover{background:var(--text-muted)}

/* ===== APP SHELL ===== */
#app{display:flex;flex-direction:column;height:100vh;max-height:100vh}

/* ===== HEADER ===== */
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 28px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;transition:background .3s ease,border-color .3s ease}
.header-left{display:flex;align-items:center;gap:16px}
.header-title{font-size:19px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:10px}
.header-icon{width:38px;height:38px;background:linear-gradient(135deg,#FFB800 0%,#FF8A47 40%,#4C9AFF 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(255,138,71,.3);overflow:hidden}
.header-icon svg{width:22px;height:22px}
.header-subtitle{font-size:12px;color:var(--text-secondary);margin-top:2px;font-weight:400}
.header-right{display:flex;align-items:center;gap:10px}
.billing-chip{display:flex;align-items:center;gap:6px;background:var(--bg);padding:6px 14px;border-radius:20px;font-size:11px;color:var(--text-secondary);border:1px solid var(--border);font-weight:500}
.billing-chip svg{width:14px;height:14px;color:var(--text-muted)}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--radius);font-weight:600;font-size:12px;transition:var(--transition);letter-spacing:.01em}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:hover{background:var(--primary-hover);box-shadow:0 4px 12px rgba(255,217,61,.25)}
html.dark .btn-primary{background:linear-gradient(135deg,#FFD93D,#FFE873);color:#0B0D14;font-weight:600}
html.dark .btn-primary:hover{background:linear-gradient(135deg,#FFE873,#FFD93D);box-shadow:0 4px 16px rgba(255,217,61,.3)}
.btn-secondary{background:var(--surface);color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover{background:var(--bg);border-color:var(--text-muted)}
.btn-ghost{background:transparent;color:var(--text-secondary)}
.btn-ghost:hover{background:var(--bg)}
.btn-sm{padding:5px 12px;font-size:11px}
.btn:disabled{opacity:.4;cursor:not-allowed;box-shadow:none!important}

/* ===== MAIN GRID ===== */
.main{display:grid;grid-template-columns:240px 1fr 220px;gap:14px;padding:14px 28px;flex:1;min-height:0;overflow:hidden}

/* ===== LEFT COLUMN ===== */
.card{background:var(--surface);border-radius:var(--radius-lg);border:1px solid var(--border);box-shadow:var(--shadow);transition:background .3s ease,border-color .3s ease,box-shadow .3s ease}
.left-col{display:flex;flex-direction:column;gap:10px;overflow-y:auto}
.wallet-card{padding:16px}
.wallet-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);font-weight:600}
.wallet-balance{font-size:30px;font-weight:800;color:var(--text);margin:4px 0 10px;font-variant-numeric:tabular-nums;letter-spacing:-.5px}
.wallet-bar-wrapper{margin-bottom:10px}
.wallet-bar{height:8px;border-radius:4px;background:var(--bg);overflow:hidden;display:flex}
.wallet-bar-spent{background:var(--primary);transition:width .4s ease;border-radius:4px 0 0 4px}
.wallet-bar-alloc{background:var(--primary-light);transition:width .4s ease}
.wallet-breakdown{display:flex;justify-content:space-between;font-size:10.5px;margin-top:5px;color:var(--text-secondary);font-weight:500}
.wallet-breakdown span{display:flex;align-items:center;gap:4px}
.dot{width:6px;height:6px;border-radius:50%;display:inline-block;flex-shrink:0}
.dot-spent{background:var(--primary)}
.dot-alloc{background:var(--primary-light)}
.dot-unalloc{background:var(--border)}
.wallet-actions{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}

/* ===== BILLING CYCLE ===== */
.billing-cycle{margin-bottom:12px;padding:10px 12px;background:var(--bg);border-radius:var(--radius);border:1px solid var(--border-light)}
.cycle-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.cycle-label{font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--text-muted);font-weight:600;display:flex;align-items:center;gap:5px}
.cycle-label svg{width:12px;height:12px;color:var(--text-muted)}
.cycle-dates{font-size:11px;font-weight:600;color:var(--text)}
.cycle-bar{height:6px;border-radius:3px;background:var(--border-light);overflow:hidden;position:relative}
.cycle-bar-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--primary),var(--info));transition:width .4s ease}
.cycle-bar-marker{position:absolute;top:-3px;width:2px;height:12px;background:var(--text);border-radius:1px;transition:left .4s ease}
.cycle-meta{display:flex;justify-content:space-between;font-size:9.5px;color:var(--text-muted);font-weight:500;margin-top:4px}
.cycle-meta strong{color:var(--text-secondary);font-weight:600}

/* ===== ALLOCATION POOLS CARD ===== */
.pools-card{padding:12px}
.pools-title{font-size:10px;font-weight:700;margin-bottom:10px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px}
.pool-section{margin-bottom:8px}
.pool-section:last-of-type{margin-bottom:0}
.pool-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px}
.pool-name{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:600}
.pool-name .pool-icon{width:20px;height:20px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff}
.pool-amount{font-size:13px;font-weight:700;font-variant-numeric:tabular-nums}
.pool-bar{height:6px;border-radius:3px;background:var(--bg);overflow:hidden;margin-bottom:4px}
.pool-bar-fill{height:100%;border-radius:3px;transition:width .4s ease}
.pool-meta{display:flex;justify-content:space-between;font-size:10px;color:var(--text-muted);font-weight:500}
.pool-meta strong{color:var(--text-secondary);font-weight:600}
.pool-divider{height:1px;background:var(--border-light);margin:10px 0}
.pool-unalloc{display:flex;align-items:center;justify-content:space-between;font-size:11px;color:var(--text-secondary);font-weight:500}
.pool-unalloc strong{color:var(--text);font-weight:700;font-size:12px}

/* ===== POLICY ===== */
.policy-card{padding:14px}
.policy-title{font-size:10px;font-weight:700;margin-bottom:8px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px}
.policy-row{display:flex;align-items:center;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border-light)}
.policy-row:last-child{border:none}
.policy-label{font-size:11px;color:var(--text-secondary);flex:1;font-weight:500}
.toggle{position:relative;width:36px;height:20px;border-radius:10px;background:var(--border);cursor:pointer;transition:var(--transition);flex-shrink:0}
.toggle.active{background:var(--success)}
.toggle::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;border-radius:50%;background:#fff;transition:var(--transition);box-shadow:0 1px 4px rgba(0,0,0,.15)}
.toggle.active::after{left:18px}

/* ===== CENTER COLUMN ===== */
.center-col{display:flex;flex-direction:column;min-height:0;overflow:hidden;gap:10px}
.widget-strip{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;flex-shrink:0}
.widget-card{padding:10px 12px;display:flex;flex-direction:column;gap:4px;min-height:0}
.widget-card .insight-title{margin-bottom:2px}
.widget-card .spend-bars{gap:4px}
.widget-card .spend-bar-row{gap:4px}
.widget-card .spend-bar-label{width:55px;font-size:9.5px}
.widget-card .spend-bar-val{width:40px;font-size:9.5px}
.widget-card .top-team-row{padding:3px 0}
.alloc-card{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:0}
.alloc-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
.alloc-header h3{font-size:14px;font-weight:700}
.alloc-error{background:var(--danger-bg);color:var(--danger);padding:8px 16px;font-size:11px;font-weight:600;display:none;align-items:center;gap:6px}
.alloc-error.visible{display:flex}
.alloc-table-wrapper{flex:1;overflow-y:auto;overflow-x:hidden}
table{width:100%;border-collapse:collapse;table-layout:fixed}
thead{position:sticky;top:0;z-index:2}
th{background:#F5F6F8;padding:8px 8px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--text-muted);font-weight:600;border-bottom:1px solid var(--border);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
td{padding:5px 8px;border-bottom:1px solid var(--border-light);vertical-align:middle;overflow:hidden;text-overflow:ellipsis}
tr.data-row:not(.row-open) td{height:38px;white-space:nowrap}
tr.data-row.row-open td{height:auto}
tr.data-row{border-left:3px solid transparent}
tr.data-row:hover td{background:#F0F6FF}
.details-drawer td{background:var(--bg)!important}
.offering-cell{display:flex;align-items:center;gap:8px}
.offering-icon{width:28px;height:28px;border-radius:var(--radius);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;overflow:hidden}
.offering-icon img{width:100%;height:100%;object-fit:cover;border-radius:var(--radius)}
.offering-icon svg{width:22px;height:22px}
.offering-icon.icon-credits svg{width:26px;height:26px}
.offering-name{font-weight:600;font-size:12px}
span.mobile-pill{display:none!important}
.offering-sub{font-size:9.5px;color:var(--text-muted);font-weight:500;display:flex;align-items:center;gap:4px;flex-wrap:wrap}
.plan-tag{display:inline-block;padding:1px 6px;border-radius:4px;font-size:8.5px;font-weight:700;background:var(--primary-bg);color:var(--primary);border:1px solid var(--primary);letter-spacing:.2px}
.pool-badge{display:inline-block;padding:2px 8px;border-radius:20px;font-size:9px;font-weight:700;letter-spacing:.3px;text-transform:uppercase}
.pool-badge-credits{background:var(--credits-bg);color:var(--credits)}
.pool-badge-seats{background:var(--seats-bg);color:var(--seats)}
.pool-badge-vibe{background:var(--vibe-bg);color:var(--vibe)}
.input-money{width:72px;padding:5px 8px;border:1px solid var(--border);border-radius:var(--radius-sm);text-align:right;font-variant-numeric:tabular-nums;transition:var(--transition);font-size:12px;font-weight:500}
.input-money:focus{border-color:var(--primary);box-shadow:0 0 0 2px var(--primary-bg)}
.input-money.error{border-color:var(--danger);box-shadow:0 0 0 2px var(--danger-bg)}
select.type-select{padding:4px 4px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--surface);color:var(--text);cursor:pointer;font-size:10px;font-weight:500;width:100%;max-width:100%}
select.bucket-select{width:100%;max-width:320px;font-size:11px;padding:6px 8px}
select.dept-select{padding:4px 6px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--surface);color:var(--text);cursor:pointer;font-size:10.5px;font-weight:500;max-width:96px}
.converts-to{font-size:11.5px;color:var(--primary);font-weight:600;font-variant-numeric:tabular-nums}
/* ===== USAGE CELL ===== */
.usage-summary{font-size:10.5px;color:var(--text-secondary);font-weight:500}
.usage-cell{display:flex;flex-direction:column;gap:3px;min-width:120px;white-space:normal}
.usage-row{display:flex;align-items:center;gap:5px;font-size:10px;font-weight:500;color:var(--text-secondary)}
.usage-row strong{color:var(--text);font-weight:700;font-variant-numeric:tabular-nums}
.usage-bar{width:48px;height:4px;border-radius:2px;background:var(--border-light);overflow:hidden;flex-shrink:0}
.usage-bar-fill{height:100%;border-radius:2px;transition:width .3s ease}
.usage-tags{display:flex;flex-wrap:wrap;gap:3px}
.usage-tag{display:inline-block;padding:1px 6px;border-radius:10px;font-size:8.5px;font-weight:600;background:var(--bg);color:var(--text-secondary);border:1px solid var(--border-light)}
/* ===== AGENT BREAKDOWN ===== */
.agent-breakdown{grid-column:1/-1;margin-top:4px}
.agent-breakdown-title{font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);font-weight:600;margin-bottom:6px}
.agent-cards{display:flex;gap:10px;flex-wrap:wrap}
.agent-card{flex:1;min-width:180px;background:var(--surface);border:1px solid var(--border-light);border-radius:var(--radius);padding:10px 12px}
.agent-card-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.agent-avatar{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff}
.agent-card-name{font-size:12px;font-weight:700;color:var(--text)}
.agent-card-desc{font-size:10px;color:var(--text-muted);margin-bottom:6px;font-weight:400}
.agent-stat-row{display:flex;justify-content:space-between;font-size:10px;padding:2px 0;color:var(--text-secondary);font-weight:500}
.agent-stat-row strong{color:var(--text);font-weight:700}
.agent-stat-bar{height:3px;border-radius:2px;background:var(--border-light);overflow:hidden;margin-top:4px}
.agent-stat-bar-fill{height:100%;border-radius:2px}
/* ===== MODEL SELECTOR ===== */
.model-cell{display:flex;flex-direction:column;gap:3px;min-width:0}
.model-select-wrap{display:flex;align-items:center;gap:6px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:4px 4px 4px 8px;max-width:210px;transition:border-color .15s ease}
.model-select-wrap:focus-within{border-color:var(--primary)}
.model-select-wrap .model-logo{width:18px;height:18px;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.model-select-wrap .model-logo svg{width:18px;height:18px}
select.model-select{flex:1;min-width:0;padding:2px 4px;border:none;background:transparent;color:var(--text);cursor:pointer;font-size:11px;font-weight:500;appearance:auto;outline:none}
.model-note{font-size:9.5px;font-weight:400;color:var(--text-muted);padding:2px 0;white-space:nowrap}
html.dark .model-select-wrap,html.dark .detail-group .model-select-wrap{background:#1A1D2B;border-color:rgba(255,255,255,.12)}
html.dark select.model-select,html.dark .detail-group select.model-select{background:transparent;color:var(--text)}
.input-cap{width:100%;max-width:100%;padding:5px 6px;border:1px solid var(--border);border-radius:var(--radius-sm);text-align:right;font-variant-numeric:tabular-nums;font-size:11px;font-weight:500;box-sizing:border-box}
.input-cap:focus{border-color:var(--primary);box-shadow:0 0 0 2px var(--primary-bg)}
.pill{display:inline-flex;align-items:center;justify-content:center;padding:3px 12px;border-radius:20px;font-size:10px;font-weight:600;white-space:nowrap;min-width:62px;text-align:center}
.pill-healthy{background:var(--success);color:#fff}
.pill-near{background:var(--warning);color:#fff}
.pill-locked{background:var(--text-muted);color:#fff}
.btn-details{display:inline-flex;align-items:center;gap:4px;font-size:10px;color:var(--text-secondary);cursor:pointer;background:var(--bg);font-weight:600;padding:4px 10px;border-radius:20px;border:1px solid var(--border-light);transition:var(--transition)}
.btn-details:hover{background:var(--primary-bg);color:var(--primary);border-color:var(--primary)}
.btn-details.open{background:var(--primary-bg);color:var(--primary);border-color:var(--primary)}
.btn-details svg{width:12px;height:12px;transition:transform .2s ease;transform:rotate(-90deg)}
.btn-details.open svg{transform:rotate(0deg)}

/* ===== DETAILS DRAWER ===== */
.details-drawer{display:none;background:var(--bg);border-bottom:1px solid var(--border)}
.details-drawer.open{display:table-row}
.details-inner{padding:14px 16px;display:grid;grid-template-columns:1fr 1fr;gap:10px 20px}
.detail-group label{display:block;font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);font-weight:600;margin-bottom:3px}
.detail-group input,.detail-group select{width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:11.5px;font-weight:500}
.detail-group input:focus,.detail-group select:focus{border-color:var(--primary)}
.team-pills{display:flex;flex-wrap:wrap;gap:4px;margin-top:3px}
.team-pill{display:inline-flex;align-items:center;gap:3px;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:600;cursor:pointer;transition:var(--transition);border:1px solid var(--border);background:var(--surface);color:var(--text-secondary)}
.team-pill.selected{background:var(--primary);color:#fff;border-color:var(--primary)}
.dept-pills{display:flex;flex-wrap:wrap;gap:4px;margin-top:3px}
.dept-pill{display:inline-flex;align-items:center;gap:3px;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:600;cursor:pointer;transition:var(--transition);border:1px solid var(--border);background:var(--surface);color:var(--text-secondary)}
.dept-pill.selected{background:var(--info);color:#fff;border-color:var(--info)}
.detail-row{display:flex;align-items:center;gap:8px}
.detail-row label{margin-bottom:0;min-width:0}
.detail-row .toggle{margin-left:auto}

/* ===== RIGHT COLUMN ===== */
.right-col{display:flex;flex-direction:column;gap:10px;overflow-y:auto}
.insight-card{padding:12px}
.insight-title{font-size:10px;font-weight:700;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;color:var(--text-secondary)}
.spend-bars{display:flex;flex-direction:column;gap:5px}
.spend-bar-row{display:flex;align-items:center;gap:5px}
.spend-bar-label{width:60px;font-size:10px;color:var(--text-secondary);text-align:right;overflow:hidden;text-overflow:ellipsis;font-weight:500}
.spend-bar-track{flex:1;height:10px;background:var(--bg);border-radius:5px;overflow:hidden}
.spend-bar-fill{height:100%;border-radius:5px;transition:width .5s ease}
.spend-bar-val{width:42px;font-size:10px;font-weight:600;font-variant-numeric:tabular-nums;color:var(--text)}
.top-teams{margin-top:2px}
.team-row{display:flex;align-items:center;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border-light);font-size:11px}
.team-row:last-child{border:none}
.team-name{font-weight:600;color:var(--text)}
.team-spend{color:var(--text-secondary);font-variant-numeric:tabular-nums;font-weight:500}
.activity-card{padding:12px;flex:1;min-height:0;display:flex;flex-direction:column}
.activity-list{display:flex;flex-direction:column;gap:0;flex:1;overflow-y:auto}
.activity-item{padding:5px 0;border-bottom:1px solid var(--border-light);display:flex;gap:6px;align-items:flex-start;font-size:10.5px}
.activity-item:last-child{border:none}
.activity-dot{width:6px;height:6px;border-radius:50%;margin-top:5px;flex-shrink:0}
.activity-text{flex:1;color:var(--text-secondary);line-height:1.4;font-weight:400}
.activity-text strong{color:var(--text);font-weight:600}
.activity-time{font-size:9.5px;color:var(--text-muted);white-space:nowrap;flex-shrink:0;font-weight:500}

/* ===== USER REQUESTS ===== */
.requests-card{padding:12px;display:flex;flex-direction:column;gap:0}
.request-item{padding:8px 0;border-bottom:1px solid var(--border-light);display:flex;flex-direction:column;gap:6px}
.request-item:last-child{border:none}
.request-top{display:flex;align-items:flex-start;gap:8px}
.request-avatar{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff;flex-shrink:0}
.request-body{flex:1;min-width:0}
.request-text{font-size:10.5px;color:var(--text-secondary);line-height:1.4;font-weight:400}
.request-text strong{color:var(--text);font-weight:600}
.request-time{font-size:9px;color:var(--text-muted);margin-top:1px;font-weight:500}
.request-actions{display:flex;gap:6px;padding-left:34px}
.btn-request{padding:3px 10px;border-radius:var(--radius-sm);font-size:9.5px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--text-secondary);transition:all .15s ease}
.btn-request:hover{background:var(--primary-bg);border-color:var(--primary);color:var(--primary)}
.btn-request-approve{background:var(--success);border-color:var(--success);color:#fff}
.btn-request-approve:hover{opacity:.85;box-shadow:0 2px 8px rgba(0,202,114,.3)}
html.dark .btn-request{border-color:rgba(255,255,255,.1);color:var(--text-secondary)}
html.dark .btn-request:hover{background:rgba(255,217,61,.06);border-color:rgba(255,217,61,.25);color:var(--primary)}
html.dark .btn-request.btn-request-approve{background:var(--success);border-color:var(--success);color:#fff}
html.dark .btn-request.btn-request-approve:hover{background:#00B868;border-color:#00B868;opacity:1;box-shadow:0 2px 12px rgba(0,202,114,.35)}

/* ===== FOOTER ===== */
.footer{display:flex;align-items:center;justify-content:space-between;padding:10px 28px;background:var(--surface);border-top:1px solid var(--border);flex-shrink:0;transition:background .3s ease,border-color .3s ease}
.footer-left{display:flex;align-items:center;gap:16px;font-size:11px;color:var(--text-muted);font-weight:500}
.sandbox-badge{display:inline-flex;align-items:center;gap:4px;background:var(--warning-bg);color:#D5890B;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:600}
.footer-right{display:flex;gap:8px}

/* ===== TOAST ===== */
.toast-container{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:1000;display:flex;flex-direction:column;align-items:center;gap:8px;pointer-events:none}
.toast{padding:10px 24px;border-radius:20px;background:var(--text);color:#fff;font-size:12px;font-weight:600;box-shadow:0 4px 24px rgba(0,0,0,.25);opacity:0;transform:translateY(-20px) scale(.95);transition:opacity .3s ease,transform .3s cubic-bezier(.4,0,.2,1);display:flex;align-items:center;gap:8px;pointer-events:auto;white-space:nowrap}
.toast.show{opacity:1;transform:translateY(0) scale(1)}
.toast-success{background:var(--success)}
.toast-error{background:var(--danger)}
.toast-info{background:var(--primary)}

/* ===== MODAL ===== */
.modal-overlay{position:fixed;inset:0;background:rgba(50,51,56,.45);z-index:500;display:none;align-items:center;justify-content:center;animation:fadeIn .2s ease}
.modal-overlay.open{display:flex}
.modal{background:var(--surface);border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);padding:28px;width:380px;animation:slideUp .25s ease}
.modal h3{font-size:17px;font-weight:700;margin-bottom:6px}
.modal p{font-size:12.5px;color:var(--text-secondary);margin-bottom:18px;font-weight:400}
.modal-actions{display:flex;gap:8px;justify-content:flex-end}
.modal label{display:block;font-size:11px;font-weight:600;margin-bottom:4px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px}
.modal input{width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:var(--radius);font-size:15px;margin-bottom:16px;font-weight:500}
.modal input:focus{border-color:var(--primary);box-shadow:0 0 0 2px var(--primary-bg)}

@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* ===== RESPONSIVE ===== */
@media(max-width:1200px){
  .main{grid-template-columns:200px 1fr 180px;gap:10px;padding:12px 16px}
  .widget-strip{gap:8px}
  .widget-card{padding:10px}
  .header{padding:10px 16px}
  .footer{padding:8px 16px}
}

/* ===== TABLET (≤ 900px) ===== */
@media(max-width:900px){
  html,body{overflow:auto;height:auto}
  #app{height:auto;min-height:100vh;max-height:none}
  .main{
    display:flex!important;flex-direction:column!important;
    gap:10px;padding:10px 12px;
    overflow:visible;
  }
  .left-col,.center-col,.right-col{display:contents!important}
  .alloc-card{overflow:visible}
  .widget-strip{display:contents!important}

  /* Reorder: wallet → widget cards → table → requests → policy → activity */
  .wallet-card{order:1!important}
  .widget-card{order:2!important}
  .widget-card.pools-card{order:2!important}
  .alloc-card{order:3!important}
  .requests-card{order:4!important}
  .policy-card{order:5!important}
  .activity-card{order:6!important}

  /* Header */
  .header{flex-wrap:wrap;gap:10px;padding:10px 14px}
  .header-left{flex:1;min-width:0}
  .header-title{font-size:16px;gap:8px}
  .header-icon{width:32px;height:32px;border-radius:8px}
  .header-icon svg{width:18px;height:18px}
  .header-subtitle{font-size:11px}
  .header-right{flex-wrap:wrap;gap:6px}

  /* Footer */
  .footer{flex-wrap:wrap;gap:8px;padding:8px 14px}
  .footer-left{flex-wrap:wrap;gap:8px}

  /* Insights */
  .insight-card{padding:10px}

  /* Modal */
  .modal{width:90vw;max-width:380px;padding:20px}
}

/* ===== PHONE (≤ 600px) — CARD LAYOUT ===== */
@media(max-width:600px){
  .main{padding:8px;gap:8px}

  /* Header — stack title and actions */
  .header{padding:10px 12px;gap:8px}
  .header-left{width:100%}
  .header-right{width:100%;justify-content:flex-start;flex-wrap:wrap;gap:6px}
  .billing-chip{font-size:10px;padding:4px 10px}
  .header-title{font-size:15px}
  .header-subtitle{font-size:10px}
  .header-icon{width:30px;height:30px}

  /* Wallet card */
  .wallet-card{padding:12px}
  .wallet-balance{font-size:26px}
  .wallet-label{font-size:9px}
  .wallet-actions{gap:6px;flex-wrap:wrap}
  .wallet-actions .btn{font-size:11px;padding:6px 12px;flex:1;min-width:0;justify-content:center}
  .wallet-breakdown{font-size:9.5px}

  /* Billing cycle */
  .billing-cycle{padding:8px 10px}
  .cycle-dates{font-size:10px}
  .cycle-meta{font-size:9px}

  /* Pools card */
  .pools-card{padding:12px}
  .pool-name{font-size:11px}
  .pool-amount{font-size:12px}
  .pool-meta{font-size:9px}

  /* Policy */
  .policy-card{padding:10px}
  .policy-label{font-size:10px}
  .toggle{width:32px;height:18px}
  .toggle::after{width:14px;height:14px}
  .toggle.active::after{left:16px}

  /* ===== TABLE → COLLAPSED CARD LAYOUT ===== */
  .alloc-table-wrapper{overflow-x:visible}
  table,thead,tbody,tr,th,td{display:block;width:100%;min-width:0!important}
  table{min-width:0!important}
  thead{display:none}
  tr.data-row{
    border:1px solid var(--border);border-radius:var(--radius-lg);
    margin-bottom:6px;padding:0;position:relative;
    border-left:3px solid;background:var(--surface);overflow:hidden;
  }
  /* First cell = always visible header with offering + status pill */
  tr.data-row td:first-child{
    display:flex!important;align-items:center;justify-content:space-between;
    padding:10px 12px;border:none!important;white-space:normal;
    cursor:pointer;box-shadow:none!important;border-right:none!important;
    position:relative!important;
  }
  tr.data-row td:first-child::before{display:none}
  /* All other cells: hidden by default */
  tr.data-row td:not(:first-child){
    display:none!important;
  }
  /* When row is expanded, show other cells */
  tr.data-row.mobile-open td:not(:first-child){
    display:flex!important;align-items:center;justify-content:space-between;
    padding:4px 12px;border:none;white-space:normal;
  }
  tr.data-row.mobile-open td:not(:first-child)::before{
    content:attr(data-label);font-size:10px;font-weight:600;
    color:var(--text-muted);text-transform:uppercase;letter-spacing:.4px;
    min-width:80px;flex-shrink:0;
  }
  /* Add a subtle top border to the first expanded cell */
  tr.data-row.mobile-open td:nth-child(2){
    border-top:1px solid var(--border-light)!important;padding-top:8px;margin-top:2px;
  }
  /* Last visible cell gets bottom padding */
  tr.data-row.mobile-open td:last-child{padding-bottom:10px}
  .offering-cell{gap:8px;flex:1}
  .offering-icon{width:26px;height:26px;border-radius:7px}
  .offering-icon.icon-credits svg{width:24px;height:24px}
  .offering-name{font-size:12px;font-weight:700}
  .offering-sub{font-size:9px}
  .input-money{width:80px;font-size:13px;padding:6px 8px;text-align:right}
  .input-cap{width:70px;font-size:13px;padding:6px 8px}
  .converts-to{font-size:12px}
  .pill{font-size:9px;padding:2px 10px;min-width:50px}
  .pool-badge{font-size:8px;padding:2px 6px}
  select.type-select{font-size:12px;padding:5px 8px}
  .model-select-wrap{max-width:none}
  select.model-select{font-size:11px}
  select.dept-select{font-size:11px;padding:5px 8px;max-width:none}
  /* Show status pill inline on mobile, hide duplicate */
  .mobile-pill{display:inline-flex!important;flex-shrink:0;margin-left:auto}
  .status-cell{display:none!important}
  /* Mobile toggle arrow styling */
  .btn-details{font-size:10px;padding:3px 6px;border:none;background:transparent}
  .btn-details:hover{background:transparent}

  /* Details drawer in card mode */
  .details-drawer{display:none}
  .details-drawer.open{display:block}
  .details-drawer.open td{display:block!important;padding:0!important;border:none}
  .details-drawer.open td::before{display:none}
  .details-inner{grid-template-columns:1fr;gap:10px;padding:12px}
  .team-pills,.dept-pills{gap:4px}
  .team-pill,.dept-pill{font-size:10px;padding:4px 10px}

  /* Alloc header */
  .alloc-header{padding:10px 12px;flex-wrap:wrap;gap:6px}
  .alloc-header h3{font-size:13px}
  .alloc-error{font-size:10px;padding:6px 10px}

  /* Insights */
  .spend-bar-label{width:52px;font-size:9.5px}
  .spend-bar-val{width:40px;font-size:9.5px}
  .spend-bar-track{height:8px}
  .team-row{font-size:10.5px;padding:6px 0}
  .activity-item{font-size:10px;gap:5px;padding:6px 0}
  .activity-dot{width:5px;height:5px;margin-top:5px}
  .activity-time{font-size:9px}

  /* Footer */
  .footer{padding:10px 12px;gap:6px}
  .footer-left{font-size:10px;gap:8px}
  .footer-right{gap:6px;width:100%;justify-content:stretch}
  .footer-right .btn{font-size:11px;padding:8px 14px;flex:1;justify-content:center}
  .sandbox-badge{font-size:9px;padding:2px 8px}

  /* Modal */
  .modal{width:calc(100vw - 32px);padding:20px;border-radius:12px}
  .modal h3{font-size:15px}
  .modal p{font-size:11.5px}
  .modal input{font-size:16px;padding:10px 14px}

  /* Toast */
  .toast-container{top:10px}
  .toast{font-size:11px;padding:8px 16px}
}
</style>
</head>
<body>
<div id="app">
  <!-- HEADER -->
  <header class="header">
    <div class="header-left">
      <div class="header-icon">
        <svg viewBox="0 0 48 48" width="22" height="22" fill="none"><rect x="4" y="12" width="40" height="28" rx="6" fill="#fff" opacity=".9"/><rect x="4" y="12" width="40" height="10" rx="4" fill="#fff"/><rect x="4" y="8" width="32" height="8" rx="4" fill="#fff" opacity=".6"/><rect x="30" y="22" width="14" height="12" rx="4" fill="rgba(245,183,49,.35)"/><circle cx="36" cy="28" r="3" fill="#fff"/></svg>
      </div>
      <div>
        <div class="header-title"><span><span style="font-weight:400">monday</span> Wallet</span></div>
        <div class="header-subtitle">Centralize funding and allocate budgets across AI offerings</div>
      </div>
    </div>
    <div class="header-right">
      <button class="theme-toggle" id="themeToggle" title="Toggle dark mode" aria-label="Toggle dark mode">
        <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      </button>
      <div class="billing-chip">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="3"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
        Corporate Card &bull;&bull;&bull;&bull; 1842
      </div>
      <button class="btn btn-primary" id="headerAddFunds" aria-label="Add Funds">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add Funds
      </button>
    </div>
  </header>

  <!-- MAIN -->
  <main class="main">
    <!-- LEFT COLUMN -->
    <div class="left-col">
      <!-- Wallet Funds -->
      <div class="card wallet-card">
        <div class="wallet-label">Total Balance</div>
        <div class="wallet-balance" id="walletBalance">$34,700</div>
        <!-- Billing Cycle -->
        <div class="billing-cycle">
          <div class="cycle-header">
            <span class="cycle-label">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
              Billing Cycle
            </span>
            <span class="cycle-dates" id="cycleDates">Feb 1 &ndash; Mar 1</span>
          </div>
          <div class="cycle-bar">
            <div class="cycle-bar-fill" id="cycleFill" style="width:39%"></div>
            <div class="cycle-bar-marker" id="cycleMarker" style="left:39%"></div>
          </div>
          <div class="cycle-meta">
            <span>Day <strong id="cycleDay">11</strong> of <strong id="cycleTotalDays">28</strong></span>
            <span><strong id="cycleDaysLeft">18</strong> days remaining</span>
          </div>
        </div>

        <div class="wallet-bar-wrapper">
          <div class="wallet-bar">
            <div class="wallet-bar-spent" id="barSpent" style="width:15%"></div>
            <div class="wallet-bar-alloc" id="barAlloc" style="width:45%"></div>
          </div>
          <div class="wallet-breakdown">
            <span><span class="dot dot-alloc"></span> Allocated: <strong id="lblAlloc">$15,000</strong></span>
            <span><span class="dot dot-unalloc"></span> Free: <strong id="lblFree">$10,000</strong></span>
          </div>
          <div class="wallet-breakdown" style="margin-top:2px">
            <span><span class="dot dot-spent"></span> Spent: <strong id="lblSpent">$3,750</strong></span>
          </div>
        </div>
        <div class="wallet-actions">
          <button class="btn btn-primary btn-sm" id="leftAddFunds">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add Funds
          </button>
          <button class="btn btn-secondary btn-sm" id="transferBack" disabled>Transfer Back</button>
          <button class="btn btn-ghost btn-sm" id="exportBtn">Export</button>
        </div>
      </div>

      <!-- Policy -->
      <div class="card policy-card">
        <div class="policy-title">Policy &amp; Guardrails</div>
        <div class="policy-row">
          <span class="policy-label">Require approval above $500</span>
          <div class="toggle active" data-policy="approval" tabindex="0" role="switch" aria-checked="true"></div>
        </div>
        <div class="policy-row">
          <span class="policy-label">Block spend when depleted</span>
          <div class="toggle active" data-policy="block" tabindex="0" role="switch" aria-checked="true"></div>
        </div>
        <div class="policy-row">
          <span class="policy-label">Notify when 80% used</span>
          <div class="toggle active" data-policy="notify" tabindex="0" role="switch" aria-checked="true"></div>
        </div>
      </div>
    </div>

    <!-- CENTER COLUMN -->
    <div class="center-col">
      <!-- Widget Strip -->
      <div class="widget-strip">
        <div class="card widget-card">
          <div class="insight-title">This Month Spend</div>
          <div class="spend-bars" id="spendBars"></div>
        </div>
        <div class="card widget-card pools-card">
          <div class="insight-title">Fund Allocation</div>
          <div class="pool-section">
            <div class="pool-header">
              <span class="pool-name"><span class="pool-icon" style="background:var(--credits)">C</span> Credits</span>
              <span class="pool-amount" id="poolCreditsAmt" style="color:var(--credits)">$8,000</span>
            </div>
            <div class="pool-bar"><div class="pool-bar-fill" id="poolCreditsBar" style="width:50%;background:var(--credits)"></div></div>
            <div class="pool-meta">
              <span>Converts to <strong id="poolCreditsUnits">8,000,000</strong> credits</span>
              <span>Spent <strong id="poolCreditsSpent">$1,990</strong></span>
            </div>
          </div>
          <div class="pool-section">
            <div class="pool-header">
              <span class="pool-name"><span class="pool-icon" style="background:var(--vibe)">V</span> Vibe Apps</span>
              <span class="pool-amount" id="poolVibeAmt" style="color:var(--vibe)">$4,000</span>
            </div>
            <div class="pool-bar"><div class="pool-bar-fill" id="poolVibeBar" style="width:50%;background:var(--vibe)"></div></div>
            <div class="pool-meta">
              <span>Covers <strong id="poolVibeUnits">200</strong> active apps</span>
              <span>Spent <strong id="poolVibeSpent">$800</strong></span>
            </div>
          </div>
        </div>
        <div class="card widget-card">
          <div class="insight-title">Top Departments Spend</div>
          <div class="top-teams" id="topTeams"></div>
        </div>
      </div>

      <div class="card alloc-card">
        <div class="alloc-header">
          <h3>Budget Allocation</h3>
          <span style="font-size:11px;color:var(--text-muted);font-weight:500" id="allocSummary">6 offerings &middot; 5 active</span>
        </div>
        <div class="alloc-error" id="allocError">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
          Total allocation exceeds wallet balance. Reduce allocations or add funds.
        </div>
        <div class="alloc-table-wrapper">
          <table>
            <thead>
              <tr>
                <th style="width:24%">Offering</th>
                <th style="width:8%">Type</th>
                <th style="width:28%">Consumption</th>
                <th style="width:12%">Period</th>
                <th style="width:16%">Period Cap</th>
                <th style="width:12%">Status</th>
              </tr>
            </thead>
            <tbody id="allocBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="right-col">
      <div class="card requests-card">
        <div class="insight-title">User Requests <span style="font-size:9px;padding:1px 7px;border-radius:10px;background:var(--danger);color:#fff;font-weight:700;margin-left:4px" id="requestsBadge">3</span></div>
        <div id="requestsList"></div>
      </div>
      <div class="card activity-card">
        <div class="insight-title">Recent Activity</div>
        <div class="activity-list" id="activityList"></div>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="footer-left">
      <span id="lastSaved">Last saved: just now</span>
      <span class="sandbox-badge">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        Sandbox mode
      </span>
    </div>
    <div class="footer-right">
      <button class="btn btn-secondary" id="discardBtn">Discard</button>
      <button class="btn btn-primary" id="saveBtn">Save Changes</button>
    </div>
  </footer>
</div>

<!-- ADD FUNDS MODAL -->
<div class="modal-overlay" id="addFundsModal">
  <div class="modal">
    <h3>Add Funds to Wallet</h3>
    <p>Funds will be charged to Corporate Card ending in 1842.</p>
    <label for="addFundsInput">Amount ($)</label>
    <input type="number" id="addFundsInput" value="5000" min="100" step="100"/>
    <div class="modal-actions">
      <button class="btn btn-secondary" id="addFundsCancel">Cancel</button>
      <button class="btn btn-primary" id="addFundsConfirm">Add Funds</button>
    </div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<script>
/* =================================================================
   STATE
   ================================================================= */
const TEAMS = ['Sales','CS','R&D','Marketing','Product'];
const DEPARTMENTS = ['All Workspaces','Engineering','Sales','Customer Success','Marketing','Product','Finance'];

let walletBalance = 34700;
let policies = { approval: true, block: true, notify: true };

/*  monday.com palette per offering
    poolType: 'credits' = usage-based, 'seats' = seat-based */
/* Icon: 'img:path' for product images, 'svg:...' for inline SVG, or emoji fallback */
const ICON_CREDITS_SVG = `<svg viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="coinG" x1="8" y1="8" x2="36" y2="36"><stop offset="0%" stop-color="#F5D060"/><stop offset="50%" stop-color="#D4A520"/><stop offset="100%" stop-color="#B8860B"/></linearGradient><linearGradient id="coinF" x1="10" y1="10" x2="34" y2="34"><stop offset="0%" stop-color="#FFE87C"/><stop offset="50%" stop-color="#DAA520"/><stop offset="100%" stop-color="#C49000"/></linearGradient><linearGradient id="starG" x1="16" y1="12" x2="28" y2="30"><stop offset="0%" stop-color="#FFF8DC"/><stop offset="100%" stop-color="#FFD700"/></linearGradient></defs><circle cx="22" cy="23" r="17" fill="#8B6914" opacity=".35"/><circle cx="22" cy="21" r="17" fill="url(#coinG)"/><circle cx="22" cy="21" r="13.5" fill="url(#coinF)"/><circle cx="22" cy="21" r="11.5" fill="none" stroke="#B8860B" stroke-width=".7" opacity=".5"/><polygon points="22,12.5 24.4,17.8 30.2,18.5 26,22.4 27,28 22,25.2 17,28 18,22.4 13.8,18.5 19.6,17.8" fill="url(#starG)" stroke="#B8860B" stroke-width=".3"/></svg>`;
const ICON_SEATS_SVG = `<svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="4" width="32" height="32" rx="8" fill="#9AADBD"/><circle cx="15" cy="16" r="4" fill="#fff"/><circle cx="25" cy="16" r="4" fill="#fff"/><path d="M10 28c0-4 4-6 10-6s10 2 10 6" stroke="#fff" stroke-width="2.5" stroke-linecap="round" fill="none"/></svg>`;

/* ===== BUCKET DEFINITIONS ===== */
const CREDIT_BUCKETS = [
  { credits:20000,   yearly:2400,   monthly:200,   label:'20K credits' },
  { credits:40000,   yearly:4800,   monthly:400,   label:'40K credits' },
  { credits:80000,   yearly:9600,   monthly:800,   label:'80K credits' },
  { credits:160000,  yearly:19200,  monthly:1600,  label:'160K credits' },
  { credits:400000,  yearly:48000,  monthly:4000,  label:'400K credits' },
  { credits:800000,  yearly:96000,  monthly:8000,  label:'800K credits', ent:true },
  { credits:2000000, yearly:240000, monthly:20000, label:'2M credits',   ent:true },
];

const VIBE_BUCKETS = [
  { apps:10,  monthly:100,  label:'10 active apps' },
  { apps:25,  monthly:250,  label:'25 active apps' },
  { apps:50,  monthly:500,  label:'50 active apps' },
  { apps:100, monthly:1000, label:'100 active apps' },
  { apps:250, monthly:2500, label:'250 active apps' },
];

const NOTETAKER_BUCKETS = [
  { hours:120,  monthly:125,  yearly:1500,  label:'120 hours' },
  { hours:250,  monthly:250,  yearly:3000,  label:'250 hours' },
  { hours:400,  monthly:375,  yearly:4500,  label:'400 hours' },
  { hours:750,  monthly:700,  yearly:8400,  label:'750 hours' },
  { hours:1000, monthly:900,  yearly:10800, label:'1,000 hours' },
];

const SIDEKICK_TIERS = [
  { name:'Sidekick Lite', price:10,  label:'Lite ($10/user/mo)' },
  { name:'Sidekick Pro',  price:10,  label:'Pro ($10/user/mo)' },
  { name:'Super Sidekick',price:30,  label:'Super ($30/user/mo)' },
];

/* ===== AI MODEL DEFINITIONS ===== */
const AI_MODELS = [
  { id:'claude-opus-4.6',   name:'Claude Opus 4.6',       provider:'Anthropic',  multiplier:1.5,
    logo:`<svg viewBox="0 0 24 24" fill="none"><path d="M13.6 3.6L21.4 20.4H16.8L14.7 15.5H9.3L13.6 3.6Z" fill="#D97757"/><path d="M10.4 3.6L2.6 20.4H7.2L9.3 15.5H14.7L10.4 3.6Z" fill="#D97757"/></svg>` },
  { id:'claude-sonnet-4',   name:'Claude Sonnet 4',       provider:'Anthropic',  multiplier:1.0,
    logo:`<svg viewBox="0 0 24 24" fill="none"><path d="M13.6 3.6L21.4 20.4H16.8L14.7 15.5H9.3L13.6 3.6Z" fill="#D97757"/><path d="M10.4 3.6L2.6 20.4H7.2L9.3 15.5H14.7L10.4 3.6Z" fill="#D97757"/></svg>` },
  { id:'claude-haiku-3.5',  name:'Claude Haiku 3.5',      provider:'Anthropic',  multiplier:0.25,
    logo:`<svg viewBox="0 0 24 24" fill="none"><path d="M13.6 3.6L21.4 20.4H16.8L14.7 15.5H9.3L13.6 3.6Z" fill="#D97757"/><path d="M10.4 3.6L2.6 20.4H7.2L9.3 15.5H14.7L10.4 3.6Z" fill="#D97757"/></svg>` },
  { id:'gpt-4.1',           name:'GPT-4.1',               provider:'OpenAI',     multiplier:1.2,
    logo:`<svg viewBox="0 0 24 24" fill="none"><path d="M22.28 11.86a5.66 5.66 0 0 0-.49-4.66 5.73 5.73 0 0 0-6.15-2.74A5.66 5.66 0 0 0 11.39.64a5.73 5.73 0 0 0-5.47 3.96A5.66 5.66 0 0 0 2.13 7.2a5.73 5.73 0 0 0 .71 6.72 5.66 5.66 0 0 0 .49 4.66 5.73 5.73 0 0 0 6.15 2.74 5.66 5.66 0 0 0 4.25 1.88 5.73 5.73 0 0 0 5.47-3.96 5.66 5.66 0 0 0 3.79-2.6 5.73 5.73 0 0 0-.71-6.72Z" fill="#10A37F"/></svg>` },
  { id:'gpt-4o',            name:'GPT-4o',                provider:'OpenAI',     multiplier:0.5,
    logo:`<svg viewBox="0 0 24 24" fill="none"><path d="M22.28 11.86a5.66 5.66 0 0 0-.49-4.66 5.73 5.73 0 0 0-6.15-2.74A5.66 5.66 0 0 0 11.39.64a5.73 5.73 0 0 0-5.47 3.96A5.66 5.66 0 0 0 2.13 7.2a5.73 5.73 0 0 0 .71 6.72 5.66 5.66 0 0 0 .49 4.66 5.73 5.73 0 0 0 6.15 2.74 5.66 5.66 0 0 0 4.25 1.88 5.73 5.73 0 0 0 5.47-3.96 5.66 5.66 0 0 0 3.79-2.6 5.73 5.73 0 0 0-.71-6.72Z" fill="#10A37F"/></svg>` },
  { id:'gpt-4o-mini',       name:'GPT-4o Mini',           provider:'OpenAI',     multiplier:0.15,
    logo:`<svg viewBox="0 0 24 24" fill="none"><path d="M22.28 11.86a5.66 5.66 0 0 0-.49-4.66 5.73 5.73 0 0 0-6.15-2.74A5.66 5.66 0 0 0 11.39.64a5.73 5.73 0 0 0-5.47 3.96A5.66 5.66 0 0 0 2.13 7.2a5.73 5.73 0 0 0 .71 6.72 5.66 5.66 0 0 0 .49 4.66 5.73 5.73 0 0 0 6.15 2.74 5.66 5.66 0 0 0 4.25 1.88 5.73 5.73 0 0 0 5.47-3.96 5.66 5.66 0 0 0 3.79-2.6 5.73 5.73 0 0 0-.71-6.72Z" fill="#10A37F"/></svg>` },
  { id:'gemini-2.5-pro',    name:'Gemini 2.5 Pro',        provider:'Google',     multiplier:1.3,
    logo:`<svg viewBox="0 0 24 24" fill="none"><path d="M12 24A14.3 14.3 0 0 0 24 12 12 12 0 0 0 12 0 14.3 14.3 0 0 0 0 12 12 12 0 0 0 12 24Z" fill="url(#ggl)"/><defs><linearGradient id="ggl" x1="0" y1="0" x2="24" y2="24"><stop stop-color="#4285F4"/><stop offset=".33" stop-color="#9B72CB"/><stop offset=".66" stop-color="#D96570"/><stop offset="1" stop-color="#D96570"/></linearGradient></defs></svg>` },
  { id:'gemini-2.5-flash',  name:'Gemini 2.5 Flash',      provider:'Google',     multiplier:0.3,
    logo:`<svg viewBox="0 0 24 24" fill="none"><path d="M12 24A14.3 14.3 0 0 0 24 12 12 12 0 0 0 12 0 14.3 14.3 0 0 0 0 12 12 12 0 0 0 12 24Z" fill="url(#ggl2)"/><defs><linearGradient id="ggl2" x1="0" y1="0" x2="24" y2="24"><stop stop-color="#4285F4"/><stop offset=".33" stop-color="#9B72CB"/><stop offset=".66" stop-color="#D96570"/><stop offset="1" stop-color="#D96570"/></linearGradient></defs></svg>` },
  { id:'llama-4-maverick',  name:'Llama 4 Maverick',      provider:'Meta',       multiplier:0.4,
    logo:`<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="11" fill="#0668E1"/><path d="M7 17V9.5C7 7 9.2 5 12 5s5 2 5 4.5V17" stroke="#fff" stroke-width="2.2" stroke-linecap="round" fill="none"/><circle cx="9.5" cy="12" r="1.5" fill="#fff"/><circle cx="14.5" cy="12" r="1.5" fill="#fff"/></svg>` },
];

const offerings = [
  { id:'credits',  name:'AI Credits',     iconType:'svg', iconData:ICON_CREDITS_SVG,       color:'#DAA520', poolType:'credits', budgetType:'Annual',    department:'All Workspaces',
    bucketIdx:2, allocated:9600, cap:12000, locked:false, modelIdx:1,
    currency:'AI Credits', rateUnit:'$0.01/', perLabel:'credit',
    spent:4800, teams:['Sales','R&D'], departments:['Engineering','Sales'],
    autoTopUp:false, topUpThreshold:500, topUpAmount:1000,
    usage:{ boards:47, boardsLimit:100, creditsUsed:47220, creditsLimit:80000,
      distribution:[
        { name:'AI Agents',     credits:18200, color:'#A29BFE' },
        { name:'AI Workflows',  credits:12400, color:'#6C5CE7' },
        { name:'Boards',        credits:8320,  color:'#DAA520' },
        { name:'Sidekick',      credits:5100,  color:'#36D8B7' },
        { name:'Vibe Apps',     credits:3200,  color:'#FD79A8' },
      ]
    } },

  { id:'agents',   name:'AI Agents',      iconType:'img', iconData:'assets/agents.png',    color:'#A29BFE', poolType:'credits', budgetType:'Monthly',   department:'Engineering',
    allocated:2000, cap:3000, locked:false, modelIdx:3,
    currency:'AI Credits', rateUnit:'$0.02/', perLabel:'action',
    spent:1720, teams:['CS','Marketing'], departments:['Engineering','Marketing'],
    autoTopUp:false, topUpThreshold:200, topUpAmount:500,
    usage:{ creditsUsed:27000, creditsLimit:100000, agents:2, tasksDone:7120,
      breakdown:[
        { name:'SDR Agent', color:'#FD79A8', desc:'Outbound prospecting & lead qualification', creditsUsed:18200, creditsLimit:60000, actions:4120, actionsLimit:8000, status:'active',
          topUp:true, topUpThreshold:5000, topUpAmount:10000, lastTopUp:'Feb 8' },
        { name:'PMO Agent', color:'#579BFC', desc:'Project tracking & resource management',    creditsUsed:8800,  creditsLimit:40000, actions:1940, actionsLimit:5000, status:'active',
          topUp:false, topUpThreshold:3000, topUpAmount:5000, lastTopUp:null }
      ]
    } },

  { id:'workflows',name:'AI Workflows',   iconType:'img', iconData:'assets/workflows.png', color:'#6C5CE7', poolType:'credits', budgetType:'Monthly',   department:'All Workspaces',
    allocated:1500, cap:2500, locked:false, modelIdx:1,
    currency:'AI Credits', rateUnit:'$0.01/', perLabel:'credit',
    spent:780, teams:['Product','R&D','Sales'], departments:['Engineering','Product','Sales'],
    autoTopUp:false, topUpThreshold:300, topUpAmount:500,
    usage:{ creditsUsed:20220, creditsLimit:50000, workflowsActive:12, workflowsTotal:18, runsThisMonth:3420 } },

  { id:'vibe',     name:'Vibe Apps',      iconType:'img', iconData:'assets/vibe.png',      color:'#FD79A8', poolType:'vibe',   budgetType:'Monthly',   department:'Engineering',
    bucketIdx:1, allocated:3000, cap:4000, locked:false, modelIdx:1,
    currency:'Active Apps', rateUnit:'$10/', perLabel:'active app/mo',
    spent:1250, teams:['Product','R&D'], departments:['Engineering','Product'],
    autoTopUp:false, topUpThreshold:400, topUpAmount:500,
    usage:{ paid:25, published:22 } },

  { id:'sidekick', name:'Sidekick',       iconType:'img', iconData:'assets/sidekick.png',  color:'#36D8B7', poolType:'seats',   budgetType:'Monthly',   department:'All Workspaces',
    tierIdx:1, users:30, allocated:3600, cap:5000, locked:false, modelIdx:0,
    currency:'Users', rateUnit:'$10/', perLabel:'user/mo',
    spent:2100, teams:['Sales','CS'], departments:['Sales','Customer Success'],
    allowMediaOverage:true,
    autoTopUp:true, topUpThreshold:300, topUpAmount:600,
    usage:{ usersAllocated:30, usersLimit:50, tiers:[
      {name:'Sidekick Lite',users:10,price:10},{name:'Sidekick Pro',users:15,price:10},{name:'Super Sidekick',users:5,price:30}
    ] } },

  { id:'notetaker',name:'AI Notetaker',   iconType:'img', iconData:'assets/notetaker.png', color:'#00CA72', poolType:'credits', budgetType:'Monthly',   department:'All Workspaces',
    bucketIdx:1, allocated:1800, cap:2500, locked:false, modelIdx:4,
    currency:'Noted Hours', rateUnit:'', perLabel:'hour',
    spent:870, teams:['Sales','Product'], departments:['Sales','Product'],
    autoTopUp:false, topUpThreshold:100, topUpAmount:300,
    usage:{ hoursUsed:104, hoursLimit:250 } },

  { id:'seats',    name:'Seats',          iconType:'svg', iconData:ICON_SEATS_SVG,         color:'#9AADBD', poolType:'seats',   budgetType:'Monthly',   department:'All Workspaces',
    allocated:5000, cap:6000, locked:false, modelIdx:4,
    currency:'Seats', rateUnit:'$10/', perLabel:'seat/mo',
    spent:3060, teams:['Sales','CS','R&D'], departments:['Engineering','Sales','Customer Success'],
    autoTopUp:false, topUpThreshold:250, topUpAmount:500,
    usage:{ usersAllocated:250, products:[{name:'CRM',count:120},{name:'Service',count:80},{name:'Work Mgmt',count:50}] } },
];

let activities = [
  { text:'<strong>Admin</strong> allocated <strong>$5,000</strong> to AI Credits', time:'2 min ago', color:'#DAA520' },
  { text:'<strong>Admin</strong> added <strong>Seats</strong> budget for all workspaces', time:'10 min ago', color:'#9AADBD' },
  { text:'<strong>Admin</strong> enabled auto top-up for <strong>Sidekick</strong>', time:'15 min ago', color:'#36D8B7' },
  { text:'<strong>Engineering</strong> reached <strong>80%</strong> budget on Credits', time:'1 hr ago', color:'#DAA520' },
  { text:'<strong>Admin</strong> added <strong>$10,000</strong> to wallet', time:'3 hrs ago', color:'#FFD93D' },
  { text:'<strong>Sales</strong> provisioned 5 new <strong>Sidekick</strong> seats', time:'5 hrs ago', color:'#36D8B7' },
];

let userRequests = [
  { id:1, user:'Daniel Lereya', initials:'DL', avatar:'#A29BFE', text:'Requesting <strong>Auto top-up</strong> in <strong>AI Agents</strong>', detail:'Threshold: 5,000 credits · Top-up: 10,000 credits', time:'5 min ago' },
  { id:2, user:'Noy Leitersdorf', initials:'NL', avatar:'#FD79A8', text:'Requesting <strong>Sidekick Pro</strong> upgrade for 8 users', detail:'Current: Sidekick Lite · Estimated: +$640/mo', time:'25 min ago' },
  { id:3, user:'Roy Mann', initials:'RM', avatar:'#36D8B7', text:'Requesting budget increase for <strong>AI Workflows</strong>', detail:'Current: $1,500 → Requested: $3,000/mo', time:'1 hr ago' },
];

const deptSpend = [
  { name:'Engineering',      amount:4920 },
  { name:'Sales',            amount:3680 },
  { name:'Customer Success', amount:2850 },
  { name:'Product',          amount:1940 },
  { name:'Marketing',        amount:1190 },
];

let openDrawer = null;
let snapshotState = null;

function saveSnapshot(){
  snapshotState = JSON.stringify(offerings.map(o=>({allocated:o.allocated,cap:o.cap,budgetType:o.budgetType,department:o.department,locked:o.locked,teams:[...o.teams],departments:[...o.departments],autoTopUp:o.autoTopUp,topUpThreshold:o.topUpThreshold,topUpAmount:o.topUpAmount,rate:o.rate,bucketIdx:o.bucketIdx,tierIdx:o.tierIdx,users:o.users,modelIdx:o.modelIdx,allowMediaOverage:o.allowMediaOverage})));
}
saveSnapshot();

/* =================================================================
   HELPERS
   ================================================================= */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const fmt = n => n.toLocaleString('en-US');
const fmtMoney = n => '$'+fmt(n);

function totalAllocated(){ return offerings.reduce((s,o)=>s+o.allocated,0); }
function totalSpent(){ return offerings.reduce((s,o)=>s+o.spent,0); }

function poolAllocated(type){ return offerings.filter(o=>o.poolType===type).reduce((s,o)=>s+o.allocated,0); }
function poolSpent(type){ return offerings.filter(o=>o.poolType===type).reduce((s,o)=>s+o.spent,0); }

function poolCreditsUnits(){
  return offerings.filter(o=>o.poolType==='credits').reduce((s,o)=>{
    if(o.id==='credits'){
      const b = CREDIT_BUCKETS[o.bucketIdx || 0];
      return s + b.credits;
    }
    if(o.id==='agents')     return s + Math.floor(o.allocated / 0.02);
    if(o.id==='workflows') return s + Math.floor(o.allocated / 0.01);
    if(o.id==='notetaker'){
      const b = NOTETAKER_BUCKETS[o.bucketIdx || 0];
      return s + b.hours;
    }
    return s;
  },0);
}

function poolVibeUnits(){
  return offerings.filter(o=>o.poolType==='vibe').reduce((s,o)=>{
    if(o.id==='vibe'){
      const b = VIBE_BUCKETS[o.bucketIdx || 0];
      return s + b.apps;
    }
    return s + Math.floor(o.allocated / 10);
  },0);
}

function getStatus(o){
  if(o.locked) return 'locked';
  const pct = o.allocated > 0 ? o.spent / o.allocated : 0;
  if(pct >= 0.8) return 'near';
  return 'healthy';
}

function convertsTo(o){
  if(o.id === 'credits'){
    const b = CREDIT_BUCKETS[o.bucketIdx || 0];
    return fmt(b.credits)+' credits';
  }
  if(o.id === 'vibe'){
    const b = VIBE_BUCKETS[o.bucketIdx || 0];
    return b.apps+' active apps';
  }
  if(o.id === 'sidekick'){
    const t = SIDEKICK_TIERS[o.tierIdx || 0];
    return o.users+' users ('+t.name+')';
  }
  if(o.id === 'agents')     return fmt(Math.floor(o.allocated / 0.02))+' actions';
  if(o.id === 'workflows') return fmt(Math.floor(o.allocated / 0.01))+' credits';
  if(o.id === 'notetaker'){
    const b = NOTETAKER_BUCKETS[o.bucketIdx || 0];
    return fmt(b.hours)+' noted hours';
  }
  if(o.id === 'seats')     return fmt(Math.floor(o.allocated / 10))+' seats/mo';
  return '-';
}

function planTag(text){
  return `<span class="plan-tag">${text}</span>`;
}

function modelCellHtml(o){
  const m = AI_MODELS[o.modelIdx ?? 1];
  const pct = Math.round(m.multiplier * 100);
  return `<div class="model-cell">
    <div class="model-select-wrap">
      <span class="model-logo">${m.logo}</span>
      <select class="model-select" data-id="${o.id}" ${o.locked?'disabled':''}>
        ${AI_MODELS.map((mod,i)=>`<option value="${i}"${i===o.modelIdx?' selected':''}>${mod.name}</option>`).join('')}
      </select>
    </div>
    <div class="model-note">Consumes ${pct}% AI Credits</div>
  </div>`;
}

function offeringSub(o){
  if(o.id === 'credits'){
    const b = CREDIT_BUCKETS[o.bucketIdx || 0];
    return `${planTag(b.label)} $${fmt(b.monthly)}/mo`;
  }
  if(o.id === 'vibe'){
    const b = VIBE_BUCKETS[o.bucketIdx || 0];
    return `${planTag(b.label)} $${fmt(b.monthly)}/mo`;
  }
  if(o.id === 'sidekick'){
    const t = SIDEKICK_TIERS[o.tierIdx || 0];
    return `${planTag(t.name)} ${o.users} users &middot; $${fmt(o.allocated)}/mo`;
  }
  if(o.id === 'agents')     return `${planTag('Pay per action')} $0.02/action`;
  if(o.id === 'workflows') return `${planTag('Pay per run')} credits per run`;
  if(o.id === 'notetaker'){
    const b = NOTETAKER_BUCKETS[o.bucketIdx || 0];
    return `${planTag(b.label)} $${fmt(b.monthly)}/mo`;
  }
  if(o.id === 'seats')     return `${planTag('Per seat')} $10/seat/mo`;
  return '';
}

function totalCreditsUsed(){
  const agents = offerings.find(x=>x.id==='agents');
  const wf = offerings.find(x=>x.id==='workflows');
  return (agents?.usage?.creditsUsed||0) + (wf?.usage?.creditsUsed||0);
}

function usageSummary(o){
  const u = o.usage;
  if(!u) return '';
  if(o.id === 'credits'){
    const total = totalCreditsUsed();
    return `<span class="usage-summary">${fmt(total)} / ${fmt(u.creditsLimit)} AI Credits</span>`;
  }
  if(o.id === 'agents'){
    return `<span class="usage-summary">${fmt(u.tasksDone)} tasks done &middot; ${fmt(u.creditsUsed)} credits</span>`;
  }
  if(o.id === 'workflows'){
    return `<span class="usage-summary">${fmt(u.workflowsActive)} active &middot; ${fmt(u.creditsUsed)} credits</span>`;
  }
  if(o.id === 'vibe'){
    const b = VIBE_BUCKETS[o.bucketIdx || 0];
    return `<span class="usage-summary">${b.apps} apps plan, ${u.published} published</span>`;
  }
  if(o.id === 'sidekick'){
    return `<span class="usage-summary">Sidekick+ &middot; ${fmt(u.usersAllocated)} users</span>`;
  }
  if(o.id === 'notetaker'){
    const b = NOTETAKER_BUCKETS[o.bucketIdx || 0];
    return `<span class="usage-summary">${fmt(u.hoursUsed)}/${fmt(b.hours)} hours</span>`;
  }
  if(o.id === 'seats'){
    return `<span class="usage-summary">${fmt(u.usersAllocated)} users</span>`;
  }
  return '';
}

function miniBar(pct, color){
  return `<div class="usage-bar"><div class="usage-bar-fill" style="width:${Math.min(pct,100)}%;background:${color}"></div></div>`;
}

function usageHtml(o){
  const u = o.usage;
  if(!u) return '';
  const c = o.color;
  if(o.id === 'credits'){
    const b = CREDIT_BUCKETS[o.bucketIdx || 0];
    const total = totalCreditsUsed();
    const pct = u.creditsLimit > 0 ? (total / u.creditsLimit) * 100 : 0;
    const dist = u.distribution || [];
    const maxDist = Math.max(...dist.map(d=>d.credits),1);
    return `<div class="usage-cell">
      <div class="usage-row"><strong>${fmt(total)}</strong> / <strong>${fmt(u.creditsLimit)}</strong> AI Credits ${miniBar(pct > 100 ? 100 : pct, c)}</div>
      <div style="display:flex;flex-direction:column;gap:3px;margin:4px 0 2px">
        ${dist.map(d=>`<div style="display:flex;align-items:center;gap:5px">
          <span style="width:70px;font-size:9px;color:var(--text-secondary);text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${d.name}</span>
          <div style="flex:1;height:4px;border-radius:2px;background:var(--border-light);overflow:hidden"><div style="height:100%;width:${d.credits/maxDist*100}%;background:${d.color};border-radius:2px"></div></div>
          <span style="width:42px;font-size:9px;font-weight:600;color:var(--text);font-variant-numeric:tabular-nums">${fmt(d.credits)}</span>
        </div>`).join('')}
      </div>
      <div class="usage-row" style="font-size:9px;color:var(--text-muted)">${fmt(b.credits)} credits plan &middot; $${fmt(b.monthly)}/mo</div>
    </div>`;
  }
  if(o.id === 'vibe'){
    const b = VIBE_BUCKETS[o.bucketIdx || 0];
    return `<div class="usage-cell">
      <div class="usage-row"><strong>${b.apps}</strong> apps plan &middot; <strong>${u.paid}</strong> paid ${miniBar(u.paid/b.apps*100, c)}</div>
      <div class="usage-row"><strong>${u.published}</strong> published</div>
    </div>`;
  }
  if(o.id === 'sidekick'){
    const pct = u.usersLimit > 0 ? u.usersAllocated/u.usersLimit*100 : 0;
    return `<div class="usage-cell">
      <div class="usage-row"><strong>Sidekick+</strong> &middot; <strong>${fmt(u.usersAllocated)}</strong>/<strong>${fmt(u.usersLimit)}</strong> users ${miniBar(pct,c)}</div>
      <div class="usage-tags">${u.tiers.map(t=>`<span class="usage-tag">${t.name} <strong>${t.users}</strong></span>`).join('')}</div>
    </div>`;
  }
  if(o.id === 'agents'){
    const pct = u.creditsLimit > 0 ? u.creditsUsed/u.creditsLimit*100 : 0;
    return `<div class="usage-cell">
      <div class="usage-row"><strong>${fmt(u.tasksDone)}</strong> tasks done ${miniBar(pct,c)}</div>
      <div class="usage-row"><strong>${u.agents}</strong> active agents &middot; <strong>${fmt(u.creditsUsed)}</strong> credits</div>
    </div>`;
  }
  if(o.id === 'workflows'){
    const pct = u.creditsLimit > 0 ? u.creditsUsed/u.creditsLimit*100 : 0;
    return `<div class="usage-cell">
      <div class="usage-row"><strong>${fmt(u.workflowsActive)}</strong> / <strong>${fmt(u.workflowsTotal)}</strong> active workflows ${miniBar(pct,c)}</div>
      <div class="usage-row"><strong>${fmt(u.runsThisMonth)}</strong> runs &middot; <strong>${fmt(u.creditsUsed)}</strong> credits used</div>
    </div>`;
  }
  if(o.id === 'notetaker'){
    const b = NOTETAKER_BUCKETS[o.bucketIdx || 0];
    const pct = b.hours > 0 ? u.hoursUsed/b.hours*100 : 0;
    return `<div class="usage-cell">
      <div class="usage-row"><strong>${fmt(u.hoursUsed)}</strong>/<strong>${fmt(b.hours)}</strong> noted hours ${miniBar(pct,c)}</div>
      <div class="usage-row" style="font-size:9px;color:var(--text-muted)">${b.label} &middot; $${fmt(b.monthly)}/mo</div>
    </div>`;
  }
  if(o.id === 'seats'){
    return `<div class="usage-cell">
      <div class="usage-row"><strong>${fmt(u.usersAllocated)}</strong> users allocated</div>
      <div class="usage-tags">${u.products.map(p=>`<span class="usage-tag">${p.name} <strong>${p.count}</strong></span>`).join('')}</div>
    </div>`;
  }
  return '';
}

/* =================================================================
   RENDER — WALLET SIDEBAR
   ================================================================= */
function renderWallet(){
  const alloc = totalAllocated();
  const spent = totalSpent();
  const free = walletBalance - alloc;
  const pctSpent = walletBalance > 0 ? (spent / walletBalance * 100) : 0;
  const pctAllocRemaining = walletBalance > 0 ? ((alloc - spent) / walletBalance * 100) : 0;

  $('#walletBalance').textContent = fmtMoney(walletBalance);
  $('#lblAlloc').textContent = fmtMoney(alloc);
  $('#lblFree').textContent = fmtMoney(Math.max(0, free));
  $('#lblSpent').textContent = fmtMoney(spent);
  $('#barSpent').style.width = Math.min(pctSpent, 100)+'%';
  $('#barAlloc').style.width = Math.max(0, Math.min(pctAllocRemaining, 100))+'%';
  $('#transferBack').disabled = alloc <= 0;

  // Allocation pools
  const creditsAlloc = poolAllocated('credits');
  const creditsSpent = poolSpent('credits');
  const seatsAlloc = poolAllocated('seats');
  const seatsSpent = poolSpent('seats');
  const unalloc = Math.max(0, walletBalance - alloc);

  $('#poolCreditsAmt').textContent = fmtMoney(creditsAlloc);
  $('#poolCreditsBar').style.width = (walletBalance > 0 ? creditsAlloc/walletBalance*100 : 0)+'%';
  $('#poolCreditsUnits').textContent = fmt(poolCreditsUnits());
  $('#poolCreditsSpent').textContent = fmtMoney(creditsSpent);

  const vibeAlloc = poolAllocated('vibe');
  const vibeSpent = poolSpent('vibe');
  $('#poolVibeAmt').textContent = fmtMoney(vibeAlloc);
  $('#poolVibeBar').style.width = (walletBalance > 0 ? vibeAlloc/walletBalance*100 : 0)+'%';
  $('#poolVibeUnits').textContent = fmt(poolVibeUnits());
  $('#poolVibeSpent').textContent = fmtMoney(vibeSpent);

  const overBudget = alloc > walletBalance;
  $('#allocError').classList.toggle('visible', overBudget);
  $('#saveBtn').disabled = overBudget;
}

/* =================================================================
   DRAWER HELPERS — bucket/tier selectors
   ================================================================= */
function drawerAllocLabel(o){
  if(o.id === 'credits')  return 'Credit Bucket';
  if(o.id === 'vibe')     return 'Active Apps Plan';
  if(o.id === 'sidekick') return 'Sidekick Tier & Users';
  if(o.id === 'agents')    return 'Budget ($)';
  if(o.id === 'workflows') return 'Budget ($)';
  if(o.id === 'notetaker') return 'Hours Bucket';
  return 'Allocated ($)';
}

function drawerAllocInput(o){
  if(o.id === 'credits'){
    return `<select class="type-select bucket-select" data-id="${o.id}" data-bucket="credits" ${o.locked?'disabled':''}>
      ${CREDIT_BUCKETS.map((b,i)=>`<option value="${i}"${i===o.bucketIdx?' selected':''}>${b.label} — $${fmt(b.monthly)}/mo ($${fmt(b.yearly)}/yr)${b.ent?' [Ent]':''}</option>`).join('')}
    </select>`;
  }
  if(o.id === 'vibe'){
    return `<select class="type-select bucket-select" data-id="${o.id}" data-bucket="vibe" ${o.locked?'disabled':''}>
      ${VIBE_BUCKETS.map((b,i)=>`<option value="${i}"${i===o.bucketIdx?' selected':''}>${b.label} — $${fmt(b.monthly)}/mo</option>`).join('')}
    </select>`;
  }
  if(o.id === 'notetaker'){
    return `<select class="type-select bucket-select" data-id="${o.id}" data-bucket="notetaker" ${o.locked?'disabled':''}>
      ${NOTETAKER_BUCKETS.map((b,i)=>`<option value="${i}"${i===o.bucketIdx?' selected':''}>${b.label} — $${fmt(b.monthly)}/mo ($${fmt(b.yearly)}/yr)</option>`).join('')}
    </select>`;
  }
  if(o.id === 'sidekick'){
    return `<div style="display:flex;flex-direction:column;gap:6px">
      <select class="type-select bucket-select" data-id="${o.id}" data-bucket="sidekick-tier" ${o.locked?'disabled':''}>
        ${SIDEKICK_TIERS.map((t,i)=>`<option value="${i}"${i===o.tierIdx?' selected':''}>${t.label}</option>`).join('')}
      </select>
      <div style="display:flex;align-items:center;gap:6px">
        <input class="input-money" type="number" min="1" step="1" value="${o.users}" data-id="${o.id}" data-field="sidekick-users" style="width:60px" ${o.locked?'disabled':''}/>
        <span style="font-size:10.5px;color:var(--text-muted);font-weight:500">users &middot; ${fmtMoney(o.allocated)}/mo</span>
      </div>
    </div>`;
  }
  return `<div style="display:flex;align-items:center;gap:6px">
    <input class="input-money" type="number" min="0" step="100" value="${o.allocated}" data-id="${o.id}" ${o.locked?'disabled':''}/>
    <span class="converts-to" style="font-size:10.5px">${convertsTo(o)}</span>
  </div>`;
}

/* =================================================================
   RENDER — BILLING CYCLE
   ================================================================= */
function renderBillingCycle(){
  const cycleStart = new Date(2026, 1, 1); // Feb 1
  const cycleEnd   = new Date(2026, 2, 1); // Mar 1
  const today      = new Date();
  const totalMs    = cycleEnd - cycleStart;
  const elapsedMs  = Math.max(0, Math.min(today - cycleStart, totalMs));
  const totalDays  = Math.round(totalMs / 86400000);
  const dayNum     = Math.max(1, Math.ceil(elapsedMs / 86400000));
  const daysLeft   = Math.max(0, totalDays - dayNum);
  const pct        = Math.min(100, (elapsedMs / totalMs) * 100);

  const fmtDate = d => d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  $('#cycleDates').innerHTML = `${fmtDate(cycleStart)} &ndash; ${fmtDate(cycleEnd)}`;
  $('#cycleFill').style.width = pct + '%';
  $('#cycleMarker').style.left = pct + '%';
  $('#cycleDay').textContent = dayNum;
  $('#cycleTotalDays').textContent = totalDays;
  $('#cycleDaysLeft').textContent = daysLeft;
}

/* =================================================================
   RENDER — TABLE
   ================================================================= */
function renderTable(){
  const tbody = $('#allocBody');
  tbody.innerHTML = '';
  let activeCount = 0;

  offerings.forEach(o => {
    if(!o.locked) activeCount++;
    const st = getStatus(o);
    const pillClass = st === 'healthy' ? 'pill-healthy' : st === 'near' ? 'pill-near' : 'pill-locked';
    const pillText = st === 'healthy' ? 'Healthy' : st === 'near' ? 'Near limit' : 'Locked';
    const poolBadge = o.poolType === 'credits'
      ? '<span class="pool-badge pool-badge-credits">Credits</span>'
      : o.poolType === 'vibe'
      ? '<span class="pool-badge pool-badge-vibe">Vibe Apps</span>'
      : '<span class="pool-badge pool-badge-seats">Seats</span>';

    const tr = document.createElement('tr');
    tr.className = 'data-row';
    tr.dataset.id = o.id;
    tr.style.borderLeftColor = o.color;
    const isOpen = openDrawer === o.id;
    if(isOpen) tr.classList.add('row-open');
    tr.innerHTML = `
      <td>
        <div class="offering-cell">
          <button class="btn-details${isOpen?' open':''}" data-id="${o.id}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></button>
          <div class="offering-icon${o.id==='credits'?' icon-credits':''}" style="background:${o.iconType==='img'?'transparent':o.color+'18'};color:${o.color}">${o.iconType==='img'?`<img src="${o.iconData}" alt="${o.name}"/>`:o.iconData}</div>
          <div style="flex:1;min-width:0">
            <div class="offering-name">${o.name}</div>
            ${isOpen?`<div class="offering-sub">${offeringSub(o)}</div>`:''}
          </div>
          <span class="mobile-pill pill ${pillClass}">${pillText}</span>
        </div>
      </td>
      <td data-label="Type">${poolBadge}</td>
      <td data-label="Consumption">${isOpen ? usageHtml(o) : usageSummary(o)}</td>
      <td data-label="Period"><select class="type-select" data-id="${o.id}" ${o.locked?'disabled':''}>
        ${['Monthly','Quarterly','Annual','One-time'].map(t=>`<option${t===o.budgetType?' selected':''}>${t}</option>`).join('')}
      </select></td>
      <td data-label="Period Cap"><input class="input-cap" type="number" min="0" step="100" value="${o.cap}" data-id="${o.id}" ${o.locked?'disabled':''}/></td>
      <td data-label="Status" class="status-cell"><span class="pill ${pillClass}">${pillText}</span></td>
    `;
    tbody.appendChild(tr);

    // drawer row
    if(openDrawer === o.id){
      const dr = document.createElement('tr');
      dr.className = 'details-drawer open';
      dr.innerHTML = `<td colspan="6">
        <div class="details-inner">
          <div class="detail-group">
            <label>${drawerAllocLabel(o)}</label>
            ${drawerAllocInput(o)}
          </div>
          <div class="detail-group">
            <label>Converts To</label>
            <div style="font-size:12px;font-weight:600;color:var(--primary)">${convertsTo(o)}</div>
            <div style="font-size:10px;color:var(--text-muted);margin-top:2px">Allocated: ${fmtMoney(o.allocated)}</div>
          </div>
          <div class="detail-group">
            <label>Model</label>
            ${modelCellHtml(o)}
          </div>
          <div class="detail-group">
            <label>Assigned Teams</label>
            <div class="team-pills">${TEAMS.map(t=>`<span class="team-pill${o.teams.includes(t)?' selected':''}" data-team="${t}" data-id="${o.id}">${t}</span>`).join('')}</div>
          </div>
          <div class="detail-group">
            <label>Departments / Workspaces</label>
            <div class="dept-pills">${DEPARTMENTS.filter(d=>d!=='All Workspaces').map(d=>`<span class="dept-pill${o.departments.includes(d)?' selected':''}" data-dept="${d}" data-id="${o.id}">${d}</span>`).join('')}</div>
          </div>
          <div class="detail-group">
            <label style="display:flex;align-items:center;gap:8px">Auto Top-up <div class="toggle${o.autoTopUp?' active':''}" data-field="autoTopUp" data-id="${o.id}" tabindex="0" role="switch" aria-checked="${o.autoTopUp}"></div></label>
            ${o.autoTopUp?`
            <div style="display:flex;gap:8px;margin-top:4px">
              <div><label style="font-size:9.5px">Threshold ($)</label><input type="number" min="0" step="50" value="${o.topUpThreshold}" data-field="topUpThreshold" data-id="${o.id}" ${o.locked?'disabled':''}/></div>
              <div><label style="font-size:9.5px">Top-up Amt ($)</label><input type="number" min="0" step="50" value="${o.topUpAmount}" data-field="topUpAmount" data-id="${o.id}" ${o.locked?'disabled':''}/></div>
            </div>`:''}
          </div>
          ${o.id==='sidekick'?`
          <div class="detail-group" style="grid-column:1/-1">
            <label style="display:flex;align-items:center;gap:8px">
              Allow image &amp; video overage → consume AI Credits
              <div class="toggle${o.allowMediaOverage?' active':''}" data-field="allowMediaOverage" data-id="${o.id}" tabindex="0" role="switch" aria-checked="${o.allowMediaOverage}"></div>
            </label>
            <span style="font-size:10px;color:var(--text-muted);font-weight:400;margin-top:2px">When Sidekick exceeds its image/video quota, extra usage will be charged to AI Credits</span>
          </div>`:''}
          <div class="detail-group" style="grid-column:1/-1;display:flex;gap:24px;align-items:center">
            <label style="display:flex;align-items:center;gap:8px;margin:0">Lock Budget <div class="toggle${o.locked?' active':''}" data-field="locked" data-id="${o.id}" tabindex="0" role="switch" aria-checked="${o.locked}"></div></label>
            <span style="font-size:10px;color:var(--text-muted);font-weight:500">Locking prevents all spend and edits</span>
          </div>
          ${o.id==='agents' && o.usage.breakdown ? `
          <div class="agent-breakdown">
            <div class="agent-breakdown-title">Agent Breakdown (${o.usage.breakdown.length} active agents)</div>
            <div class="agent-cards">
              ${o.usage.breakdown.map(a => `
              <div class="agent-card">
                <div class="agent-card-header">
                  <div class="agent-avatar" style="background:${a.color}">${a.name.charAt(0)}</div>
                  <div>
                    <div class="agent-card-name">${a.name}</div>
                    <span style="font-size:9px;padding:1px 6px;border-radius:10px;background:${a.status==='active'?'var(--success)':'var(--text-muted)'};color:#fff;font-weight:600;text-transform:uppercase">${a.status}</span>
                  </div>
                </div>
                <div class="agent-card-desc">${a.desc}</div>
                <div class="agent-stat-row"><span>Credits Used</span><strong>${fmt(a.creditsUsed)} / ${fmt(a.creditsLimit)}</strong></div>
                <div class="agent-stat-bar"><div class="agent-stat-bar-fill" style="width:${Math.min(100,a.creditsUsed/a.creditsLimit*100)}%;background:${a.color}"></div></div>
                <div class="agent-stat-row" style="margin-top:4px"><span>Actions</span><strong>${fmt(a.actions)} / ${fmt(a.actionsLimit)}</strong></div>
                <div class="agent-stat-bar"><div class="agent-stat-bar-fill" style="width:${Math.min(100,a.actions/a.actionsLimit*100)}%;background:${a.color}80"></div></div>
                <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border-light)">
                  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">
                    <span style="font-size:10px;font-weight:600;color:var(--text-secondary)">Auto Top-up</span>
                    <span style="font-size:9px;padding:1px 6px;border-radius:10px;background:${a.topUp?'var(--success)':'var(--border)'};color:${a.topUp?'#fff':'var(--text-muted)'};font-weight:600">${a.topUp?'ON':'OFF'}</span>
                  </div>
                  ${a.topUp ? `
                  <div class="agent-stat-row"><span>Threshold</span><strong>${fmt(a.topUpThreshold)} credits</strong></div>
                  <div class="agent-stat-row"><span>Top-up Amount</span><strong>${fmt(a.topUpAmount)} credits</strong></div>
                  <div class="agent-stat-row"><span>Last Top-up</span><strong>${a.lastTopUp || '—'}</strong></div>
                  ` : `<div style="font-size:9px;color:var(--text-muted)">Threshold: ${fmt(a.topUpThreshold)} &middot; Amount: ${fmt(a.topUpAmount)}</div>`}
                </div>
              </div>
              `).join('')}
            </div>
          </div>
          ` : ''}
        </div>
      </td>`;
      tbody.appendChild(dr);
    }
  });

  $('#allocSummary').textContent = `${offerings.length} offerings \u00B7 ${activeCount} active`;
  renderWallet();
}

/* =================================================================
   RENDER — RIGHT COLUMN
   ================================================================= */
function renderInsights(){
  const maxSpend = Math.max(...offerings.map(o=>o.spent));
  $('#spendBars').innerHTML = offerings.map(o=>{
    const pct = maxSpend > 0 ? o.spent / maxSpend * 100 : 0;
    return `<div class="spend-bar-row">
      <span class="spend-bar-label">${o.name.replace('AI ','')}</span>
      <div class="spend-bar-track"><div class="spend-bar-fill" style="width:${pct}%;background:${o.color}"></div></div>
      <span class="spend-bar-val">${fmtMoney(o.spent)}</span>
    </div>`;
  }).join('');

  $('#topTeams').innerHTML = deptSpend.map(t=>`
    <div class="team-row"><span class="team-name">${t.name}</span><span class="team-spend">${fmtMoney(t.amount)}</span></div>
  `).join('');
}

function renderActivity(){
  $('#activityList').innerHTML = activities.slice(0,6).map(a=>`
    <div class="activity-item">
      <span class="activity-dot" style="background:${a.color}"></span>
      <span class="activity-text">${a.text}</span>
      <span class="activity-time">${a.time}</span>
    </div>
  `).join('');
}

function renderRequests(){
  const list = $('#requestsList');
  if(!list) return;
  list.innerHTML = userRequests.map(r=>`
    <div class="request-item" data-rid="${r.id}">
      <div class="request-top">
        <div class="request-avatar" style="background:${r.avatar}">${r.initials}</div>
        <div class="request-body">
          <div class="request-text"><strong>${r.user}</strong> — ${r.text}</div>
          <div class="request-time">${r.detail} · ${r.time}</div>
        </div>
      </div>
      <div class="request-actions">
        <button class="btn-request btn-request-info" data-rid="${r.id}">More info</button>
        <button class="btn-request btn-request-approve" data-rid="${r.id}">Approve</button>
      </div>
    </div>
  `).join('');
  const badge = $('#requestsBadge');
  if(badge) badge.textContent = userRequests.length;
  if(badge) badge.style.display = userRequests.length > 0 ? '' : 'none';
}

/* =================================================================
   TOAST
   ================================================================= */
function toast(msg, type='success'){
  const container = $('#toastContainer');
  container.querySelectorAll('.toast').forEach(t=>t.remove());
  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.innerHTML = msg;
  container.appendChild(el);
  requestAnimationFrame(()=> el.classList.add('show'));
  setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),400); }, 2500);
}

/* =================================================================
   ADD FUNDS MODAL
   ================================================================= */
function openAddFunds(){
  $('#addFundsModal').classList.add('open');
  $('#addFundsInput').value = 5000;
  $('#addFundsInput').focus();
}
function closeAddFunds(){ $('#addFundsModal').classList.remove('open'); }

$('#headerAddFunds').addEventListener('click', openAddFunds);
$('#leftAddFunds').addEventListener('click', openAddFunds);
$('#addFundsCancel').addEventListener('click', closeAddFunds);
$('#addFundsModal').addEventListener('click', e=>{ if(e.target === $('#addFundsModal')) closeAddFunds(); });

$('#addFundsConfirm').addEventListener('click', ()=>{
  const amt = parseInt($('#addFundsInput').value) || 0;
  if(amt < 100){ toast('Minimum $100','error'); return; }
  walletBalance += amt;
  activities.unshift({ text:`<strong>Admin</strong> added <strong>${fmtMoney(amt)}</strong> to wallet`, time:'Just now', color:'#FFD93D' });
  closeAddFunds();
  renderWallet();
  renderActivity();
  toast(`${fmtMoney(amt)} added to wallet`);
});

/* =================================================================
   TABLE INTERACTIONS (delegation)
   ================================================================= */
$('#allocBody').addEventListener('click', e=>{
  /* Mobile: tap offering header row to expand/collapse */
  const isMobile = window.innerWidth <= 600;
  if(isMobile){
    const firstCell = e.target.closest('tr.data-row td:first-child');
    if(firstCell && !e.target.closest('.btn-details')){
      const row = firstCell.closest('tr.data-row');
      row.classList.toggle('mobile-open');
      const btn = row.querySelector('.btn-details');
      if(btn) btn.classList.toggle('open', row.classList.contains('mobile-open'));
      return;
    }
  }
  const detBtn = e.target.closest('.btn-details');
  if(detBtn){
    const id = detBtn.dataset.id;
    if(isMobile){
      const row = detBtn.closest('tr.data-row');
      if(row){
        row.classList.toggle('mobile-open');
        detBtn.classList.toggle('open', row.classList.contains('mobile-open'));
      }
      return;
    }
    openDrawer = openDrawer === id ? null : id;
    renderTable();
    renderInsights();
    return;
  }
  const tp = e.target.closest('.team-pill');
  if(tp){
    const o = offerings.find(x=>x.id===tp.dataset.id);
    if(o.locked) return;
    const t = tp.dataset.team;
    if(o.teams.includes(t)) o.teams = o.teams.filter(x=>x!==t);
    else o.teams.push(t);
    renderTable();
    return;
  }
  const dp = e.target.closest('.dept-pill');
  if(dp){
    const o = offerings.find(x=>x.id===dp.dataset.id);
    if(o.locked) return;
    const d = dp.dataset.dept;
    if(o.departments.includes(d)) o.departments = o.departments.filter(x=>x!==d);
    else o.departments.push(d);
    activities.unshift({text:`<strong>Admin</strong> updated departments for <strong>${o.name}</strong>`,time:'Just now',color:o.color});
    renderTable();
    renderActivity();
    return;
  }
  const tog = e.target.closest('.toggle');
  if(tog && tog.dataset.field){
    const o = offerings.find(x=>x.id===tog.dataset.id);
    if(tog.dataset.field === 'autoTopUp'){
      o.autoTopUp = !o.autoTopUp;
      if(o.autoTopUp){
        activities.unshift({text:`<strong>Admin</strong> enabled auto top-up for <strong>${o.name}</strong>`,time:'Just now',color:o.color});
      }
    } else if(tog.dataset.field === 'allowMediaOverage'){
      o.allowMediaOverage = !o.allowMediaOverage;
      activities.unshift({text:`<strong>Admin</strong> ${o.allowMediaOverage?'enabled':'disabled'} image/video overage for <strong>${o.name}</strong>`,time:'Just now',color:o.color});
    } else if(tog.dataset.field === 'locked'){
      o.locked = !o.locked;
      activities.unshift({text:`<strong>Admin</strong> ${o.locked?'locked':'unlocked'} <strong>${o.name}</strong> budget`,time:'Just now',color:o.color});
    }
    renderTable();
    renderInsights();
    renderActivity();
    return;
  }
});

$('#allocBody').addEventListener('input', e=>{
  const id = e.target.dataset.id;
  const o = offerings.find(x=>x.id===id);
  if(!o) return;

  if(e.target.classList.contains('input-money')){
    if(e.target.dataset.field === 'sidekick-users'){
      o.users = Math.max(1, parseInt(e.target.value)||1);
      const t = SIDEKICK_TIERS[o.tierIdx || 0];
      o.allocated = o.users * t.price;
    } else {
      o.allocated = Math.max(0, parseInt(e.target.value)||0);
    }
    renderWallet();
    renderTable();
    const overBudget = totalAllocated() > walletBalance;
    e.target.classList.toggle('error', overBudget);
  }
  if(e.target.classList.contains('input-cap')){
    o.cap = Math.max(0, parseInt(e.target.value)||0);
  }
  if(e.target.dataset.field === 'rate'){
    o.rate = Math.max(0, parseFloat(e.target.value)||0);
    renderTable();
  }
  if(e.target.dataset.field === 'topUpThreshold'){
    o.topUpThreshold = Math.max(0, parseInt(e.target.value)||0);
  }
  if(e.target.dataset.field === 'topUpAmount'){
    o.topUpAmount = Math.max(0, parseInt(e.target.value)||0);
  }
});

$('#allocBody').addEventListener('change', e=>{
  /* Model selector */
  if(e.target.classList.contains('model-select')){
    const o = offerings.find(x=>x.id===e.target.dataset.id);
    if(!o) return;
    o.modelIdx = parseInt(e.target.value);
    const m = AI_MODELS[o.modelIdx];
    activities.unshift({text:`<strong>Admin</strong> switched <strong>${o.name}</strong> model to <strong>${m.name}</strong>`,time:'Just now',color:o.color});
    renderTable();
    renderActivity();
    return;
  }
  /* Bucket / tier selectors */
  if(e.target.classList.contains('bucket-select')){
    const o = offerings.find(x=>x.id===e.target.dataset.id);
    if(!o) return;
    const idx = parseInt(e.target.value);
    if(e.target.dataset.bucket === 'credits'){
      o.bucketIdx = idx;
      const b = CREDIT_BUCKETS[idx];
      o.allocated = o.budgetType === 'Annual' ? b.yearly : b.monthly;
    } else if(e.target.dataset.bucket === 'vibe'){
      o.bucketIdx = idx;
      const b = VIBE_BUCKETS[idx];
      o.allocated = b.monthly;
    } else if(e.target.dataset.bucket === 'notetaker'){
      o.bucketIdx = idx;
      const b = NOTETAKER_BUCKETS[idx];
      o.allocated = b.monthly;
    } else if(e.target.dataset.bucket === 'sidekick-tier'){
      o.tierIdx = idx;
      const t = SIDEKICK_TIERS[idx];
      o.allocated = o.users * t.price;
    }
    activities.unshift({text:`<strong>Admin</strong> changed <strong>${o.name}</strong> plan to <strong>${convertsTo(o)}</strong>`,time:'Just now',color:o.color});
    renderTable();
    renderWallet();
    renderActivity();
    return;
  }
  if(e.target.classList.contains('type-select') && !e.target.classList.contains('bucket-select')){
    const o = offerings.find(x=>x.id===e.target.dataset.id);
    if(o){
      o.budgetType = e.target.value;
      if(o.id === 'credits'){
        const b = CREDIT_BUCKETS[o.bucketIdx || 0];
        o.allocated = o.budgetType === 'Annual' ? b.yearly : b.monthly;
        renderTable();
        renderWallet();
      }
    }
  }
  if(e.target.classList.contains('dept-select')){
    const o = offerings.find(x=>x.id===e.target.dataset.id);
    if(o){
      o.department = e.target.value;
      activities.unshift({text:`<strong>Admin</strong> assigned <strong>${o.name}</strong> to <strong>${o.department}</strong>`,time:'Just now',color:o.color});
      renderActivity();
    }
  }
});

/* =================================================================
   POLICY TOGGLES
   ================================================================= */
document.addEventListener('click', e=>{
  const tog = e.target.closest('.toggle[data-policy]');
  if(!tog) return;
  const key = tog.dataset.policy;
  policies[key] = !policies[key];
  tog.classList.toggle('active', policies[key]);
  tog.setAttribute('aria-checked', policies[key]);
  toast(`Policy "${key}" ${policies[key]?'enabled':'disabled'}`, 'info');
  activities.unshift({text:`<strong>Admin</strong> ${policies[key]?'enabled':'disabled'} policy <strong>${key}</strong>`, time:'Just now', color:'#FFD93D'});
  renderActivity();
});

document.addEventListener('keydown', e=>{
  if((e.key === 'Enter' || e.key === ' ') && e.target.classList.contains('toggle')){
    e.preventDefault();
    e.target.click();
  }
});

/* =================================================================
   FOOTER ACTIONS
   ================================================================= */
$('#saveBtn').addEventListener('click', ()=>{
  if(totalAllocated() > walletBalance) return;
  saveSnapshot();
  activities.unshift({text:'<strong>Admin</strong> saved all allocation changes', time:'Just now', color:'#00CA72'});
  renderActivity();
  $('#lastSaved').textContent = 'Last saved: just now';
  toast('Changes saved successfully');
});

$('#discardBtn').addEventListener('click', ()=>{
  if(!snapshotState) return;
  const snap = JSON.parse(snapshotState);
  offerings.forEach((o,i)=>{
    Object.assign(o, snap[i]);
  });
  openDrawer = null;
  renderTable();
  renderInsights();
  renderActivity();
  toast('Changes discarded','info');
});

$('#transferBack').addEventListener('click', ()=>{
  const active = offerings.filter(o=>o.allocated > 0 && !o.locked);
  if(!active.length) return;
  const smallest = active.reduce((a,b)=>a.allocated < b.allocated ? a : b);
  const amt = smallest.allocated;
  smallest.allocated = 0;
  activities.unshift({text:`<strong>Admin</strong> transferred <strong>${fmtMoney(amt)}</strong> back from <strong>${smallest.name}</strong>`, time:'Just now', color:smallest.color});
  renderTable();
  renderInsights();
  renderActivity();
  toast(`${fmtMoney(amt)} transferred back from ${smallest.name}`);
});

$('#exportBtn').addEventListener('click', ()=>{
  toast('Allocation report exported (CSV)','info');
  activities.unshift({text:'<strong>Admin</strong> exported allocation report', time:'Just now', color:'#FFD93D'});
  renderActivity();
});

/* =================================================================
   DARK MODE
   ================================================================= */
function initTheme(){
  const saved = localStorage.getItem('wallet-theme');
  if(saved === 'light'){
    document.documentElement.classList.remove('dark');
  } else {
    document.documentElement.classList.add('dark');
  }
}
initTheme();

$('#themeToggle').addEventListener('click', ()=>{
  document.documentElement.classList.toggle('dark');
  const isDark = document.documentElement.classList.contains('dark');
  localStorage.setItem('wallet-theme', isDark ? 'dark' : 'light');
  toast(isDark ? 'Dark mode enabled' : 'Light mode enabled', 'info');
});

/* =================================================================
   USER REQUEST ACTIONS
   ================================================================= */
document.addEventListener('click', e=>{
  if(e.target.classList.contains('btn-request-approve')){
    const rid = parseInt(e.target.dataset.rid);
    const req = userRequests.find(r=>r.id===rid);
    if(!req) return;
    userRequests = userRequests.filter(r=>r.id!==rid);
    activities.unshift({text:`<strong>Admin</strong> approved request from <strong>${req.user}</strong>`, time:'Just now', color:'#00CA72'});
    renderRequests();
    renderActivity();
    toast(`Approved request from ${req.user}`);
  }
  if(e.target.classList.contains('btn-request-info')){
    const rid = parseInt(e.target.dataset.rid);
    const req = userRequests.find(r=>r.id===rid);
    if(!req) return;
    toast(`${req.user}: ${req.detail}`, 'info');
  }
});

/* =================================================================
   INIT
   ================================================================= */
renderTable();
renderInsights();
renderActivity();
renderRequests();
renderBillingCycle();
</script>
</body>
</html>
